<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pupka Tracker (HTML)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–ª–∞–≤–Ω–æ—ó –ø–æ—è–≤–∏/–∑–Ω–∏–∫–Ω–µ–Ω–Ω—è */
        .hidden-item {
            display: none;
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }
        .visible-item {
            display: block;
            opacity: 1;
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ */
        #reset-modal.hidden-item { display: none; }
        #reset-modal.visible-item { display: flex; }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å */
        #status-alert.hidden-item { 
            display: none;
            opacity: 0;
            transform: translateX(100%);
        }
        #status-alert.visible-item { 
            display: flex;
            opacity: 1;
            transform: translateX(0);
        }

        /* –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∫–ª—ñ–∫–∞–º –ø—ñ–¥ —á–∞—Å –±–ª–æ–∫—É–≤–∞–Ω–Ω—è */
        .ui-blocked {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8 font-sans">

    <!-- –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="max-w-4xl mx-auto space-y-8">
        
        <!-- –•–µ–¥–µ—Ä —ñ –°—Ç–∞—Ç—É—Å -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- –°–µ–∫—Ü—ñ—è –°—Ç–∞—Ç—É—Å—É (StatusDisplay) -->
            <div class="md:col-span-1">
                <div class="bg-white p-6 rounded-2xl shadow-xl text-center space-y-4">
                    <h1 class="text-3xl font-extrabold text-indigo-700">–ü—É–ø–∫–∞</h1>
                    
                    <!-- Health Display -->
                    <div id="heart-display" class="flex justify-center mb-4 gap-1">
                        <!-- –°–µ—Ä—Ü—è –±—É–¥—É—Ç—å –≤—Å—Ç–∞–≤–ª–µ–Ω—ñ —Å—é–¥–∏ -->
                    </div>

                    <!-- Character Visualization (Pupka Image) -->
                    <div id="image-container" class="w-28 h-28 mx-auto mb-4 rounded-full overflow-hidden shadow-xl border-4 border-indigo-200 transition-all duration-300 transform hover:scale-105 cursor-pointer"
                         role="button"
                         aria-label="–ó–º—ñ–Ω–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ü—É–ø–∫–∏">
                        <img id="pupka-image"
                             src="image_915fcc.jpg" 
                             alt="Pupka Character" 
                             class="w-full h-full object-cover"
                             onerror="this.onerror=null; this.src='https://placehold.co/112x112/ff9900/ffffff?text=Pupka'; this.className='w-full h-full object-contain p-2';">
                    </div>
                    
                    <!-- –ü–æ–ª–µ –≤–≤–æ–¥—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (ImageUploader) -->
                    <div id="image-uploader" class="hidden-item p-4 mt-4 bg-indigo-50 rounded-xl border border-indigo-300 space-y-3">
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-indigo-800 flex items-center">
                                <i data-lucide="image" class="w-5 h-5 mr-2"></i> –í—Å—Ç–∞–≤–∏—Ç–∏ (Ctrl+V)
                            </h4>
                            <button id="close-image-uploader" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x-circle" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <!-- –ü–æ–ª–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ -->
                        <div id="paste-area"
                             tabindex="0" 
                             class="w-full p-4 h-24 border-2 border-dashed rounded-lg text-center cursor-text transition-all duration-200 bg-white border-gray-300 hover:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <p id="paste-prompt" class="text-gray-500 font-medium mt-2">
                                –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —Ç—É—Ç —ñ –≤—Å—Ç–∞–≤—Ç–µ (Ctrl+V)
                            </p>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è -->
                        <button id="remove-image-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-red-500 hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed w-full">
                            <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>
                            –°–∫–∏–Ω—É—Ç–∏ —Ñ–æ—Ç–æ –ü—É–ø–∫–∏
                        </button>
                    </div>

                    <!-- Evolution Level -->
                    <div class="font-semibold text-lg text-gray-600 pt-4 border-t border-gray-100" id="level-prefix">
                        –†—ñ–≤–µ–Ω—å 1
                    </div>
                    <h2 class="text-2xl font-bold text-indigo-600 mb-2" id="level-name">...</h2>
                    <p class="text-sm italic text-gray-500" id="level-description">...</p>

                    <!-- XP Bar -->
                    <div class="pt-2">
                        <div class="text-sm font-medium text-gray-700 flex justify-between">
                            <span id="xp-current-text">XP: 0</span>
                            <span id="xp-needed-text">–î–æ –ù–∞—Å—Ç. –†—ñ–≤–Ω—è: 101</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 mt-1">
                            <div id="xp-progress-bar"
                                 class="h-4 rounded-full transition-all duration-700 bg-yellow-500"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –°–µ–∫—Ü—ñ—è –î–æ–¥–∞–≤–∞–Ω–Ω—è XP (XpInputSection) -->
            <div class="md:col-span-2">
                <div id="xp-section-content" class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <i data-lucide="zap" class="w-6 h-6 mr-2 text-indigo-600"></i> –î–æ–¥–∞—Ç–∏ XP –∑–∞ –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è
                    </h3>
                    
                    <!-- –ú–Ω–æ–∂–Ω–∏–∫ X2 -->
                    <label class="flex items-center space-x-3 p-3 bg-yellow-50 rounded-lg border border-yellow-300 cursor-pointer transition-all hover:bg-yellow-100">
                        <input id="multiplier-checkbox" 
                               type="checkbox" 
                               class="form-checkbox h-5 w-5 text-indigo-600 rounded">
                        <span id="multiplier-label" class="font-semibold text-yellow-800">...</span>
                    </label>

                    <!-- –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π -->
                    <div id="rewards-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-96 overflow-y-auto pr-2">
                        <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –±—É–¥—É—Ç—å –≤—Å—Ç–∞–≤–ª–µ–Ω—ñ —Å—é–¥–∏ -->
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ –î—ñ—ó XP -->
                    <div class="flex space-x-3 pt-2">
                        <!-- –ö–ù–û–ü–ö–ê –í–Ü–î–ú–Ü–ù–ò / –ö–†–û–ö –ù–ê–ó–ê–î -->
                        <button id="undo-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-orange-500 hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="rotate-ccw" class="w-5 h-5 mr-2"></i>
                            –ö—Ä–æ–∫ –Ω–∞–∑–∞–¥
                        </button>
                        
                        <!-- –ö–ù–û–ü–ö–ê –ó–ê–†–ê–•–£–í–ê–¢–ò XP -->
                        <button id="add-xp-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex-grow">
                            <i data-lucide="chevrons-up" class="w-5 h-5 mr-2"></i>
                            –ó–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ XP
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü—ñ—è –î—ñ–π —Ç–∞ –Ü—Å—Ç–æ—Ä—ñ—è -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- –°–µ–∫—Ü—ñ—è –ö–Ω–æ–ø–æ–∫ –î—ñ–π (ActionButtons) -->
            <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                <h3 class="text-xl font-bold text-gray-800">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ó–¥–æ—Ä–æ–≤'—è–º (‚ù§Ô∏è)</h3>

                <!-- –ó–¥–æ—Ä–æ–≤'—è = 0 (CPR) -->
                <div id="cpr-section" class="hidden-item p-4 bg-red-100 border border-red-400 rounded-xl text-red-800 font-semibold text-center space-y-3">
                    <p class="font-bold text-lg">üíÄ –°–º–µ—Ä—Ç—å –ü—É–ø–∫–∏!</p>
                    <p>–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ ¬´–®—Ç—É—á–Ω–µ –¥–∏—Ö–∞–Ω–Ω—è¬ª!</p>
                    <button id="cpr-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed w-full">
                        <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>
                        42 –∫–º –∑–∞ 2 –¥–Ω—ñ (–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ 1 ‚ù§Ô∏è)
                    </button>
                    <p class="text-sm text-red-600">–Ø–∫—â–æ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–æ, –ü—É–ø–∫–∞ –ø–æ–º–µ—Ä–ª–∞ –Ω–∞–∑–∞–≤–∂–¥–∏.</p>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –î—ñ—ó -->
                <div id="action-buttons-container" class="grid grid-cols-2 gap-3">
                    <button id="show-heal-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-pink-600 hover:bg-pink-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="heart" class="w-5 h-5 mr-2"></i>
                        –õ—ñ–∫—É–≤–∞–Ω–Ω—è (+1 ‚ù§Ô∏è)
                    </button>
                    <button id="show-penalty-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-gray-600 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="x-circle" class="w-5 h-5 mr-2"></i>
                        –®—Ç—Ä–∞—Ñ (‚Äî ‚ù§Ô∏è/XP)
                    </button>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å –õ—ñ–∫—É–≤–∞–Ω–Ω—è -->
                <div id="heal-options" class="hidden-item p-4 bg-pink-50 rounded-xl border border-pink-300 space-y-2">
                    <h4 class="font-semibold text-pink-800">–í–∏–∫–æ–Ω–∞–Ω—ñ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –õ—ñ–∫—É–≤–∞–Ω–Ω—è (+1 ‚ù§Ô∏è):</h4>
                    <div id="heal-tasks-list">
                        <!-- –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –ª—ñ–∫—É–≤–∞–Ω–Ω—è -->
                    </div>
                    <button id="close-heal-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-gray-400 hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed w-full mt-2">
                        –ó–∞–∫—Ä–∏—Ç–∏
                    </button>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å –®—Ç—Ä–∞—Ñ—ñ–≤ -->
                <div id="penalty-options" class="hidden-item p-4 bg-gray-50 rounded-xl border border-gray-300 space-y-2">
                    <h4 class="font-semibold text-gray-800">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –®—Ç—Ä–∞—Ñ:</h4>
                    <div id="penalty-tasks-list">
                        <!-- –®—Ç—Ä–∞—Ñ–∏ -->
                    </div>
                    <button id="close-penalty-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-gray-400 hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed w-full mt-2">
                        –ó–∞–∫—Ä–∏—Ç–∏
                    </button>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –°–∫–∏–¥–∞–Ω–Ω—è/–ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è -->
                <div class="pt-4 border-t border-gray-200">
                    <button id="show-reset-modal-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-red-500 hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed w-full">
                        <i data-lucide="rotate-ccw" class="w-5 h-5 mr-2"></i>
                        –ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–°–∫–∏–Ω—É—Ç–∏ –≤—Å–µ)
                    </button>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü—ñ—è –Ü—Å—Ç–æ—Ä—ñ—ó (HistorySection) -->
            <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4 col-span-1 lg:col-span-2" id="history-section-content">
                <h3 class="text-xl font-bold text-gray-800">–Ü—Å—Ç–æ—Ä—ñ—è –ü—Ä–æ–≥—Ä–µ—Å—É (–û—Å—Ç–∞–Ω–Ω—ñ 10)</h3>
                <div class="max-h-80 overflow-y-auto space-y-2 pr-2" id="history-list">
                    <p class="text-gray-500 italic">–¢—É—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏–º—É—Ç—å—Å—è –≤–∞—à—ñ –¥—ñ—ó.</p>
                </div>
                <p class="text-xs text-center text-gray-400">ID –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: <span id="user-id-display">...</span> (–î–ª—è —Å–ø—ñ–ª—å–Ω–æ–≥–æ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è)</p>
            </div>

        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –°–∫–∏–¥–∞–Ω–Ω—è (ResetConfirmationModal) -->
    <div id="reset-modal" class="hidden-item fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full space-y-4">
            <h3 class="text-xl font-bold text-red-600">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</h3>
            <p class="text-gray-700">–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ü—É–ø–∫—É?</p>
            <p class="text-sm text-gray-500">–¶—è –¥—ñ—è —Å–∫–∏–Ω–µ **XP, –ó–¥–æ—Ä–æ–≤'—è** —Ç–∞ **–ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–ª–∏—Ç—å —ñ—Å—Ç–æ—Ä—ñ—é**. –¶–µ –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-reset-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-gray-500 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
                <button id="confirm-reset-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="rotate-ccw" class="w-5 h-5 mr-2"></i>
                    <span id="reset-btn-text">–ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏</span>
                </button>
            </div>
        </div>
    </div>

    <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –°—Ç–∞—Ç—É—Å (StatusAlert) -->
    <div id="status-alert" class="hidden-item fixed bottom-4 right-4 z-50 p-4 rounded-xl shadow-lg border-l-4 font-semibold max-w-xs transition-all duration-300">
        <span id="status-alert-icon-container">
            <!-- –Ü–∫–æ–Ω–∫–∞ –±—É–¥–µ —Ç—É—Ç -->
        </span>
        <span id="status-alert-text">...</span>
    </div>

    <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á (Loader) -->
    <div id="loader" class="flex items-center justify-center min-h-screen bg-gray-100 fixed inset-0 z-50">
        <div class="text-indigo-600 text-lg font-semibold flex items-center">
            <i data-lucide="refresh-cw" class="w-6 h-6 mr-3 animate-spin"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ü—É–ø–∫–∏...
        </div>
    </div>


    <!-- JavaScript -->
    <script type="module">
        // --- FIREBASE –Ü–ú–ü–û–†–¢–ò ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction, serverTimestamp, collection, query, limit, orderBy, getDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- –ö–û–ù–°–¢–ê–ù–¢–ò –ì–†–ò ---
        const LEVELS = [
          { name: '–ü—É–ø–∫–∞ (–ü–æ—á–∞—Ç–∫–æ–≤–∞ –ú–æ–ª–µ–∫—É–ª–∞)', minXp: 0, maxXp: 100, description: '–ú–∞–ª–µ–Ω—å–∫–∞, –∞–ª–µ –∂–≤–∞–≤–∞ —ñ—Å—Ç–æ—Ç–∞' },
          { name: '–ú—ñ–∫—Ä–æ–æ—Ä–≥–∞–Ω—ñ–∑–º', minXp: 101, maxXp: 250, description: '–ü–æ—á–∏–Ω–∞—î —Ä—É—Ö–∞—Ç–∏—Å—å —ñ —Å–≤—ñ—Ç–∏—Ç–∏—Å—å' },
          { name: '–ö–ª—ñ—Ç–∏–Ω–∫–∞ –ñ–∏—Ç—Ç—è', minXp: 251, maxXp: 500, description: '–ú–∞—î —Å–∏–ª—É –π —Ñ–æ—Ä–º—É' },
          { name: '–ú–∞–ª–µ–Ω—å–∫–µ –ó–≤—ñ—Ä—è—Ç–∫–æ', minXp: 501, maxXp: 900, description: '–ü–æ—á–∏–Ω–∞—î –ø—Ä–æ—è–≤–ª—è—Ç–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä' },
          { name: '–õ—é–¥–∏–Ω–∫–∞-–ü—É–ø–∫–∞', minXp: 901, maxXp: 1500, description: '–°–ø—Ä–∞–≤–∂–Ω—ñ–π –≥–µ—Ä–æ–π ‚Äî –¥–æ—Å—è–≥ –≥–∞—Ä–º–æ–Ω—ñ—ó' },
          { name: '–í–∏—â–∞ —Ñ–æ—Ä–º–∞ (–ù–æ–≤–∏–π –°–≤—ñ—Ç)', minXp: 1501, maxXp: 9999, description: '–î–æ—Å—è–≥–Ω—É—Ç–∞ –Ω–æ–≤–∞, –Ω–µ–≤—ñ–¥–æ–º–∞ —Ñ–æ—Ä–º–∞!' },
        ];
        const MAX_HEALTH = 7;
        const REWARDS = [
          { id: 'base', name: 'üèÉ‚Äç‚ôÇÔ∏è –ë–∞–∑–æ–≤–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è (20+ —Ö–≤)', xp: 10 },
          { id: 'rain', name: 'üåßÔ∏è –ü–æ–≥–∞–Ω–∞ –ø–æ–≥–æ–¥–∞ / –î–æ—â', xp: 5, isBonus: true },
          { id: 'run5k', name: 'üèÉ‚Äç‚ôÄÔ∏è 5 –∫–º –±—ñ–≥—É', xp: 10 },
          { id: 'run10k', name: 'üèÉ 10 –∫–º –±—ñ–≥—É', xp: 25 },
          { id: 'run15k', name: 'ü¶ø 15 –∫–º –±—ñ–≥—É', xp: 50 },
          { id: 'squat150', name: 'üèãÔ∏è 150 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 10 },
          { id: 'squat300', name: 'üèãÔ∏è‚Äç‚ôÇÔ∏è 300 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 25 },
          { id: 'squat600', name: 'üèãÔ∏è‚Äç‚ôÄÔ∏è 600 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 50 },
          { id: 'squat1000', name: 'üí™ 1000 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 100 },
          { id: 'pullup50', name: 'ü™ú 50 –ø—ñ–¥—Ç—è–≥—É–≤–∞–Ω—å (–¥–ª—è –Ω—å–æ–≥–æ)', xp: 5 },
          { id: 'pullup100', name: 'üßó 100 –ø—ñ–¥—Ç—è–≥—É–≤–∞–Ω—å (–¥–ª—è –Ω—å–æ–≥–æ)', xp: 10 },
          { id: 'menstrual', name: 'ü©∏ –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –º—ñ—Å—è—á–Ω–∏—Ö (–¥–ª—è –Ω–µ—ó)', xp: 5, isBonus: true },
          { id: 'walk3k', name: 'üö∂ –ü—Ä–æ–≥—É–ª—è–Ω–∫–∞ 3+ –∫–º', xp: 5 },
          { id: 'yoga', name: 'üßò –†–æ–∑—Ç—è–∂–∫–∞ / –ô–æ–≥–∞ (30 —Ö–≤)', xp: 10 },
          { id: 'early', name: 'üåÖ –†–∞–Ω–∫–æ–≤–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –¥–æ 8:00', xp: 5, isBonus: true },
          { id: 'fasted', name: 'üçΩÔ∏è –ë—ñ–≥ –Ω–∞—Ç—â–µ—Å–µ—Ä—Ü–µ', xp: 5, isBonus: true },
          { id: 'together', name: 'ü§ù –°–ø—ñ–ª—å–Ω–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è', xp: 10, isBonus: true },
          { id: 'reading', name: 'üìö –ß–∏—Ç–∞–Ω–Ω—è –∫–Ω–∏–≥–∏ (30 —Ö–≤)', xp: 5 },
        ];
        const MULTIPLIER = { id: 'gymX2', name: '‚≠ê –î–æ–¥–∞—Ç–∫–æ–≤–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è —É —Å–ø–æ—Ä—Ç–∑–∞–ª—ñ (√ó2 XP)', factor: 2 };
        const HEALING_TASKS = [
            { id: 'heal_squat500', name: 'üèãÔ∏è‚Äç‚ôÇÔ∏è 500 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å' },
            { id: 'heal_water', name: 'üíß –ü–∏—Ç–∏ 2.5 –ª –≤–æ–¥–∏ (3 –¥–Ω—ñ –ø–æ—Å–ø—ñ–ª—å)' },
            { id: 'heal_meditate', name: 'üßò –†–æ–∑—Ç—è–∂–∫–∞ 30 —Ö–≤ (5 –¥–Ω—ñ–≤ –ø–æ—Å–ø—ñ–ª—å)' }, 
            { id: 'heal_diet', name: 'üö´ –¢–∏–∂–¥–µ–Ω—å –±–µ–∑ —Å–æ–ª–æ–¥–∫–æ–≥–æ/—Ñ–∞—Å—Ç—Ñ—É–¥—É (7 –¥–Ω—ñ–≤)' },
            { id: 'heal_nodopamine', name: 'üìµ 24 –≥–æ–¥–∏–Ω–∏ –±–µ–∑ –ª–µ–≥–∫–æ–≥–æ –¥–æ—Ñ–∞–º—ñ–Ω—É (–°–æ—Ü–º–µ—Ä–µ–∂—ñ/–Ü–≥—Ä–∏)' },
        ];
        const PENALTIES = [
            { id: 'skip', name: '–ü—Ä–æ–ø—É—Å–∫ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è', health: -1, xp: 0 },
            { id: 'no_evolve', name: '–î–≤–∞ —Ç–∏–∂–Ω—ñ –±–µ–∑ –µ–≤–æ–ª—é—Ü—ñ—ó', health: -2, xp: 0 },
            { id: 'no_circle', name: '–ë–µ–∑ "–∫—Ä—É–∂–µ—á–∫—É" (–≤—ñ–¥–µ–æ–∑–≤—ñ—Ç—É)', health: 0, xp: -10 },
        ];

        // --- FIREBASE –¢–ê ID –ö–û–ù–°–¢–ê–ù–¢–ò ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const GAME_DOC_ID = 'main_pupka_data';
        const DEFAULT_PUPKA_IMAGE_URL = 'image_915fcc.jpg';

        // --- –ì–õ–û–ë–ê–õ–¨–ù–ò–ô –°–¢–ê–ù ---
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let isDead = false;
        let isSaving = false;

        // –°—Ç–∞–Ω –≥—Ä–∏
        let xp = 0;
        let health = MAX_HEALTH;
        let history = [];
        let characterBase64 = '';
        let lastActionId = null;

        // –°—Ç–∞–Ω UI
        let showImageInput = false;
        let showHealOptions = false;
        let showPenaltyOptions = false;
        let showResetModal = false;
        let selectedActivities = [];
        let hasMultiplier = false;
        let statusMessageTimer = null;

        // --- DOM –ï–õ–ï–ú–ï–ù–¢–ò ---
        const dom = {
            loader: document.getElementById('loader'),
            // Status
            heartDisplay: document.getElementById('heart-display'),
            imageContainer: document.getElementById('image-container'),
            pupkaImage: document.getElementById('pupka-image'),
            imageUploader: document.getElementById('image-uploader'),
            closeImageUploader: document.getElementById('close-image-uploader'),
            pasteArea: document.getElementById('paste-area'),
            pastePrompt: document.getElementById('paste-prompt'),
            removeImageBtn: document.getElementById('remove-image-btn'),
            levelPrefix: document.getElementById('level-prefix'),
            levelName: document.getElementById('level-name'),
            levelDescription: document.getElementById('level-description'),
            xpCurrentText: document.getElementById('xp-current-text'),
            xpNeededText: document.getElementById('xp-needed-text'),
            xpProgressBar: document.getElementById('xp-progress-bar'),
            // XP Input
            xpSectionContent: document.getElementById('xp-section-content'),
            multiplierCheckbox: document.getElementById('multiplier-checkbox'),
            multiplierLabel: document.getElementById('multiplier-label'),
            rewardsList: document.getElementById('rewards-list'),
            undoBtn: document.getElementById('undo-btn'),
            addXpBtn: document.getElementById('add-xp-btn'),
            // Actions
            cprSection: document.getElementById('cpr-section'),
            cprBtn: document.getElementById('cpr-btn'),
            actionButtonsContainer: document.getElementById('action-buttons-container'),
            showHealBtn: document.getElementById('show-heal-btn'),
            showPenaltyBtn: document.getElementById('show-penalty-btn'),
            healOptions: document.getElementById('heal-options'),
            healTasksList: document.getElementById('heal-tasks-list'),
            closeHealBtn: document.getElementById('close-heal-btn'),
            penaltyOptions: document.getElementById('penalty-options'),
            penaltyTasksList: document.getElementById('penalty-tasks-list'),
            closePenaltyBtn: document.getElementById('close-penalty-btn'),
            showResetModalBtn: document.getElementById('show-reset-modal-btn'),
            // History
            historySectionContent: document.getElementById('history-section-content'),
            historyList: document.getElementById('history-list'),
            userIdDisplay: document.getElementById('user-id-display'),
            // Modal
            resetModal: document.getElementById('reset-modal'),
            cancelResetBtn: document.getElementById('cancel-reset-btn'),
            confirmResetBtn: document.getElementById('confirm-reset-btn'),
            resetBtnText: document.getElementById('reset-btn-text'),
            // Alert
            statusAlert: document.getElementById('status-alert'),
            statusAlertIconContainer: document.getElementById('status-alert-icon-container'),
            statusAlertText: document.getElementById('status-alert-text'),
        };

        // --- –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á UI ---

        function toggleElement(el, show) {
            if (show) {
                el.classList.remove('hidden-item');
                el.classList.add('visible-item');
            } else {
                el.classList.remove('visible-item');
                el.classList.add('hidden-item');
            }
        }

        function setButton(button, { text, disabled }) {
            if (text) button.innerText = text;
            button.disabled = disabled;
        }

        function showStatusMessage(type, text) {
            if (statusMessageTimer) clearTimeout(statusMessageTimer);

            dom.statusAlertText.textContent = text;
            
            let colorClass, iconName;
            switch (type) {
                case 'success':
                    colorClass = 'bg-green-100 text-green-800 border-green-400';
                    iconName = 'check-circle';
                    break;
                case 'error':
                    colorClass = 'bg-red-100 text-red-800 border-red-400';
                    iconName = 'x-circle';
                    break;
                case 'warning':
                    colorClass = 'bg-yellow-100 text-yellow-800 border-yellow-400';
                    iconName = 'zap';
                    break;
                case 'info':
                default:
                    colorClass = 'bg-blue-100 text-blue-800 border-blue-400';
                    iconName = 'refresh-cw';
                    break;
            }
            
            dom.statusAlert.className = `fixed bottom-4 right-4 z-50 p-4 rounded-xl shadow-lg border-l-4 font-semibold max-w-xs transition-all duration-300 ${colorClass} visible-item`;
            
            const iconEl = document.createElement('i');
            iconEl.setAttribute('data-lucide', iconName);
            iconEl.className = `w-5 h-5 mr-3 ${type === 'info' ? 'animate-spin' : ''}`;
            dom.statusAlertIconContainer.innerHTML = '';
            dom.statusAlertIconContainer.appendChild(iconEl);
            lucide.createIcons();

            statusMessageTimer = setTimeout(() => {
                toggleElement(dom.statusAlert, false);
            }, 5000);
        }

        // --- –§–£–ù–ö–¶–Ü–á –†–ï–ù–î–ï–†–£ (–û–ù–û–í–õ–ï–ù–ù–Ø UI) ---

        function renderHeartDisplay() {
            dom.heartDisplay.innerHTML = '';
            for (let i = 0; i < MAX_HEALTH; i++) {
                const heart = document.createElement('i');
                heart.setAttribute('data-lucide', 'heart');
                heart.className = `w-6 h-6 transition-colors duration-300 ${i < health ? 'fill-red-500 text-red-500' : 'fill-gray-300 text-gray-400'}`;
                dom.heartDisplay.appendChild(heart);
            }
            lucide.createIcons();
        }

        function renderStatusDisplay() {
            renderHeartDisplay();
            
            dom.pupkaImage.src = characterBase64 || DEFAULT_PUPKA_IMAGE_URL;
            dom.removeImageBtn.disabled = isSaving || !characterBase64 || isDead;

            const currentLevel = LEVELS.find(l => xp >= l.minXp && xp <= l.maxXp) || LEVELS[0];
            const nextLevel = LEVELS[LEVELS.indexOf(currentLevel) + 1] || currentLevel;

            dom.levelPrefix.textContent = `–†—ñ–≤–µ–Ω—å ${LEVELS.indexOf(currentLevel) + 1}`;
            dom.levelName.textContent = currentLevel.name;
            dom.levelDescription.textContent = currentLevel.description;

            dom.xpCurrentText.textContent = `XP: ${xp}`;
            
            let xpToNext, progress;
            if (currentLevel.maxXp === nextLevel.maxXp) {
                xpToNext = 0;
                progress = 100;
            } else {
                const range = nextLevel.minXp - currentLevel.minXp;
                const progressInLevel = xp - currentLevel.minXp;
                progress = Math.min(100, (progressInLevel / range) * 100);
                xpToNext = nextLevel.minXp - xp;
                if (xp >= nextLevel.minXp) {
                   xpToNext = nextLevel.maxXp - xp;
                }
            }

            dom.xpNeededText.textContent = xpToNext > 0 ? `–î–æ –ù–∞—Å—Ç. –†—ñ–≤–Ω—è: ${xpToNext}` : 'MAX';
            dom.xpProgressBar.style.width = `${progress}%`;
            dom.xpProgressBar.className = `h-4 rounded-full transition-all duration-700 ${progress >= 100 ? 'bg-green-500' : 'bg-yellow-500'}`;
        }
        
        function renderXpInputSection() {
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
            dom.rewardsList.innerHTML = '';
            REWARDS.forEach(reward => {
                let rewardName = (reward.id === 'yoga') ? 'üßò –†–æ–∑—Ç—è–∂–∫–∞ / –ô–æ–≥–∞ (30 —Ö–≤)' : reward.name;
                
                const isSelected = selectedActivities.includes(reward.id);
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border cursor-pointer transition-all ${
                  isSelected 
                    ? 'bg-indigo-100 border-indigo-500 shadow-md' 
                    : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                }`;
                div.innerHTML = `
                    <div class="font-medium text-gray-700">${rewardName}</div>
                    <div class="text-sm font-bold ${reward.isBonus ? 'text-green-600' : 'text-indigo-600'}">+${reward.xp} XP</div>
                `;
                div.onclick = () => toggleActivity(reward.id);
                dom.rewardsList.appendChild(div);
            });

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫
            dom.multiplierCheckbox.checked = hasMultiplier;
            dom.addXpBtn.disabled = selectedActivities.length === 0 || isSaving || isDead;
            dom.undoBtn.disabled = !lastActionId || isSaving || isDead;
        }

        function renderActionButtons() {
            // –°—Ç–∞–Ω —Å–º–µ—Ä—Ç—ñ
            toggleElement(dom.cprSection, isDead);
            
            // –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–æ–∫, —è–∫—â–æ –º–µ—Ä—Ç–≤–∏–π
            if (isDead) {
                dom.actionButtonsContainer.classList.add('opacity-50', 'pointer-events-none');
                // –°—Ö–æ–≤–∞—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç—ñ –æ–ø—Ü—ñ—ó
                toggleElement(dom.healOptions, false);
                toggleElement(dom.penaltyOptions, false);
                showHealOptions = false;
                showPenaltyOptions = false;
            } else {
                dom.actionButtonsContainer.classList.remove('opacity-50', 'pointer-events-none');
            }
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫
            dom.cprBtn.disabled = isSaving;
            dom.showHealBtn.disabled = isSaving || isDead || health === MAX_HEALTH;
            dom.showPenaltyBtn.disabled = isSaving || isDead;

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—ñ–≤ (—Ä–æ–±–∏–º–æ —Ü–µ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∏ —Å—Ç–∞—Ç–∏—á–Ω—ñ)
            // (–í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –≤ initUI)

            // –°—Ç–∞–Ω –≤–∏–¥–∏–º–æ—Å—Ç—ñ
            toggleElement(dom.healOptions, showHealOptions && !isDead);
            toggleElement(dom.penaltyOptions, showPenaltyOptions && !isDead);
        }

        function renderHistory() {
            if (history.length === 0) {
                dom.historyList.innerHTML = '<p class="text-gray-500 italic">–¢—É—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏–º—É—Ç—å—Å—è –≤–∞—à—ñ –¥—ñ—ó.</p>';
                return;
            }

            dom.historyList.innerHTML = '';
            history.forEach(item => {
                const healthStatus = item.details?.endHealth !== undefined && item.details.endHealth !== null
                    ? ` (${item.details.endHealth}/${MAX_HEALTH} ‚ù§Ô∏è)`
                    : '';
                const isLastAction = lastActionId === item.id;
                const timestamp = item.timestamp && item.timestamp.seconds 
                    ? new Date(item.timestamp.seconds * 1000).toLocaleTimeString('uk-UA', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) 
                    : '...';

                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border-l-4 shadow-sm flex justify-between items-center transition-all duration-300 ${
                    isLastAction 
                        ? 'border-orange-500 bg-orange-100' 
                        : 'border-indigo-500 bg-gray-50'
                }`;
                
                div.innerHTML = `
                    <span class="text-gray-700 font-medium break-words w-4/5">
                        ${isLastAction ? '<span class="font-extrabold text-orange-700 mr-1">[–û–°–¢–ê–ù–ù–Ø]</span>' : ''}
                        ${item.details?.description || item.type}
                        <span class="font-bold text-indigo-600">${healthStatus}</span>
                    </span>
                    <span class="text-xs text-gray-500 whitespace-nowrap flex items-center">
                      <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                      ${timestamp}
                    </span>
                `;
                dom.historyList.appendChild(div);
            });
            lucide.createIcons();
        }

        function renderAll() {
            if (!isAuthReady) return;
            
            renderStatusDisplay();
            renderXpInputSection();
            renderActionButtons();
            renderHistory();
            
            // –ì–ª–æ–±–∞–ª—å–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è UI
            const uiSections = [dom.xpSectionContent, dom.actionButtonsContainer, dom.historySectionContent, dom.imageContainer];
            if (isDead) {
                uiSections.forEach(el => el.classList.add('ui-blocked'));
                dom.imageContainer.classList.add('opacity-70', 'cursor-not-allowed');
                dom.imageContainer.classList.remove('hover:scale-105', 'cursor-pointer');
            } else {
                uiSections.forEach(el => el.classList.remove('ui-blocked'));
                 dom.imageContainer.classList.remove('opacity-70', 'cursor-not-allowed');
                 dom.imageContainer.classList.add('hover:scale-105', 'cursor-pointer');
            }
            
            // –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –¥–ª—è ImageUploader
            if (isDead) {
                dom.pasteArea.classList.add('opacity-50', 'cursor-not-allowed');
                dom.pasteArea.style.pointerEvents = 'none';
                dom.removeImageBtn.disabled = true;
                dom.closeImageUploader.disabled = true;
            } else {
                dom.pasteArea.classList.remove('opacity-50', 'cursor-not-allowed');
                dom.pasteArea.style.pointerEvents = 'auto';
                dom.removeImageBtn.disabled = isSaving || !characterBase64;
                 dom.closeImageUploader.disabled = false;
            }

            dom.userIdDisplay.textContent = userId || '...';
        }

        // --- –õ–û–ì–Ü–ö–ê FIREBASE ---

        const getDocRef = () => doc(db, `artifacts/${appId}/users/${userId}/pupka_game/${GAME_DOC_ID}`);
        const getHistoryColRef = () => collection(getDocRef(), 'history');

        const addHistoryEntry = async (type, details, endHealth) => {
            if (!db || userId === 'anon-local') return null;
            try {
                const historyRef = doc(getHistoryColRef());
                await setDoc(historyRef, {
                    type,
                    details: { ...details, endHealth },
                    timestamp: serverTimestamp(),
                }, { merge: true });
                return historyRef.id;
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó:", e);
                return null;
            }
        };

        const updateGameState = async (xpChange, healthUpdate, description, type) => {
            if (!db || userId === 'anon-local' || isSaving) {
                console.warn("–ù–µ –º–æ–∂—É –∑–±–µ—Ä–µ–≥—Ç–∏: DB –Ω–µ –≥–æ—Ç–æ–≤–∞ –∞–±–æ –≤–∂–µ –∑–±–µ—Ä—ñ–≥–∞—é.");
                return;
            }
            
            setIsSaving(true);
            renderAll(); // –û–Ω–æ–≤–∏—Ç–∏ UI, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞–Ω –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            const docRef = getDocRef();

            try {
                let finalHealth = -1;
                
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    
                    let currentXp = 0;
                    let currentHealth = MAX_HEALTH;
                    let currentBase64 = '';

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentHealth = data.health !== undefined && data.health !== null ? data.health : MAX_HEALTH;
                        currentXp = data.xp || 0;
                        currentBase64 = data.characterBase64 || '';
                    }
                    
                    let calculatedHealth;
                    if (healthUpdate === 'SET_TO_ONE' && currentHealth <= 0) {
                        calculatedHealth = 1;
                    } else if (typeof healthUpdate === 'number') {
                        calculatedHealth = Math.min(MAX_HEALTH, Math.max(0, currentHealth + healthUpdate));
                    } else {
                        calculatedHealth = currentHealth;
                    }

                    const calculatedXp = Math.max(0, currentXp + xpChange);
                    
                    isDead = calculatedHealth <= 0; // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
                    finalHealth = calculatedHealth;
                    
                    const currentLevel = LEVELS.find(l => calculatedXp >= l.minXp && calculatedXp <= l.maxXp) || LEVELS[0];

                    transaction.set(docRef, { 
                        xp: calculatedXp, 
                        health: calculatedHealth,
                        characterBase64: currentBase64, 
                        updatedAt: serverTimestamp(),
                        level: currentLevel.name,
                    }, { merge: true });
                    
                    return { finalHealth };
                });
                
                const newHistoryId = await addHistoryEntry(type, { 
                    xpChange: xpChange, 
                    healthChange: healthUpdate, 
                    description: description 
                }, finalHealth);

                if (newHistoryId) {
                    await setDoc(docRef, { lastActionId: newHistoryId }, { merge: true });
                    // lastActionId –æ–Ω–æ–≤–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ onSnapshot
                }
                
                console.log("–°—Ç–∞–Ω –≥—Ä–∏ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ.");

            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É:", e);
                showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
            } finally {
                setIsSaving(false);
                // onSnapshot –æ–Ω–æ–≤–∏—Ç—å UI
            }
        };

        const handleUndoLastAction = async () => {
            if (!lastActionId || isSaving || !db || userId === 'anon-local') {
                showStatusMessage('warning', '–ù–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏: –Ω–µ–º–∞—î –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –¥—ñ—ó –∞–±–æ —Å–∏—Å—Ç–µ–º–∞ –∑–∞–π–Ω—è—Ç–∞.');
                return;
            }

            setIsSaving(true);
            renderAll();
            const docRef = getDocRef();
            const historyDocRef = doc(getHistoryColRef(), lastActionId);

            try {
                let description = '';
                let isCprUndo = false;
                
                const historySnap = await getDoc(historyDocRef);
                if (!historySnap.exists()) {
                    showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞: –∑–∞–ø–∏—Å —ñ—Å—Ç–æ—Ä—ñ—ó –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.');
                    await setDoc(docRef, { lastActionId: null }, { merge: true });
                    // lastActionId –æ–Ω–æ–≤–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ onSnapshot
                    setIsSaving(false);
                    renderAll();
                    return;
                }
                
                const historyData = historySnap.data();
                const details = historyData.details || {};
                
                const undoneXpChange = details.xpChange ? -details.xpChange : 0;
                let undoneHealthChange = 0;
                
                if (typeof details.healthChange === 'number') {
                    undoneHealthChange = -details.healthChange;
                } else if (details.healthChange === 'SET_TO_ONE') {
                    isCprUndo = true;
                }
                
                description = `–í–Ü–î–ú–Ü–ù–ê: ${details.description || '–Ω–µ–≤—ñ–¥–æ–º–æ—ó –¥—ñ—ó'}`;

                if (isCprUndo) {
                    showStatusMessage('error', '–í—ñ–¥–º—ñ–Ω–∞ ¬´–®—Ç—É—á–Ω–æ–≥–æ –¥–∏—Ö–∞–Ω–Ω—è¬ª (CPR) –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è.');
                    setIsSaving(false);
                    renderAll();
                    return;
                }
                
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (!docSnap.exists()) throw new Error("–û—Å–Ω–æ–≤–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç Pupka –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.");

                    const data = docSnap.data();
                    const currentXp = data.xp || 0;
                    const currentHealth = data.health !== undefined && data.health !== null ? data.health : MAX_HEALTH;

                    const calculatedXp = Math.max(0, currentXp + undoneXpChange);
                    const calculatedHealth = Math.min(MAX_HEALTH, Math.max(0, currentHealth + undoneHealthChange));
                    const newLevel = (LEVELS.find(l => calculatedXp >= l.minXp && calculatedXp <= l.maxXp) || LEVELS[0]).name;

                    transaction.update(docRef, { 
                        xp: calculatedXp, 
                        health: calculatedHealth,
                        lastActionId: null,
                        updatedAt: serverTimestamp(),
                        level: newLevel
                    });
                    
                    transaction.delete(historyDocRef);
                });
                
                showStatusMessage('success', `–î—ñ—è —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–º—ñ–Ω–µ–Ω–∞: ${description}`);
                // lastActionId –æ–Ω–æ–≤–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ onSnapshot
                
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤—ñ–¥–º—ñ–Ω–∏:", e);
                showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–º—ñ–Ω–∏ –¥—ñ—ó. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
            } finally {
                setIsSaving(false);
                // onSnapshot –æ–Ω–æ–≤–∏—Ç—å UI
            }
        };

        const handleSaveBase64 = async (base64) => {
            if (isDead) {
                showStatusMessage('warning', '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ù–µ –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏ —Ñ–æ—Ç–æ, –ø–æ–∫–∏ —ó—ó –Ω–µ –æ–∂–∏–≤–ª—è—Ç—å!');
                return;
            }
            if (!db || userId === 'anon-local' || isSaving) return;
            
            setIsSaving(true);
            renderAll();
            showStatusMessage('info', '–ó–±–µ—Ä—ñ–≥–∞—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...');

            const docRef = getDocRef();
            try {
                await setDoc(docRef, { characterBase64: base64, updatedAt: serverTimestamp() }, { merge: true });
                // characterBase64 –æ–Ω–æ–≤–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ onSnapshot
                toggleElement(dom.imageUploader, false);
                showImageInput = false;
                showStatusMessage('success', '–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ü—É–ø–∫–∏ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
                console.log("Base64 –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ.");
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è Base64 –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:", e);
                showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è. –ú–æ–∂–ª–∏–≤–æ, –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ (–ª—ñ–º—ñ—Ç Firestore 1–ú–ë).');
            } finally {
                setIsSaving(false);
                // onSnapshot –æ–Ω–æ–≤–∏—Ç—å UI
            }
        };

        const handleRemoveImage = () => {
            if (isDead) {
                showStatusMessage('warning', '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ù–µ –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏ —Ñ–æ—Ç–æ, –ø–æ–∫–∏ —ó—ó –Ω–µ –æ–∂–∏–≤–ª—è—Ç—å!');
                return;
            }
            handleSaveBase64('');
            toggleElement(dom.imageUploader, false);
            showImageInput = false;
        };

        const handleResetCharacter = async () => {
            if (!db || userId === 'anon-local' || isSaving) return;

            setIsSaving(true);
            setButton(dom.confirmResetBtn, { text: '–°–∫–∏–¥–∞—é...', disabled: true });
            dom.cancelResetBtn.disabled = true;

            try {
                const docRef = getDocRef();
                await setDoc(docRef, { 
                    xp: 0, 
                    health: MAX_HEALTH,
                    characterBase64: '',
                    lastActionId: null,
                    updatedAt: serverTimestamp(),
                    level: LEVELS[0].name,
                }, { merge: true });
                
                const historyColRef = getHistoryColRef();
                const historySnapshot = await getDocs(historyColRef);
                const batch = writeBatch(db);
                historySnapshot.docs.forEach((d) => batch.delete(d.ref));
                await batch.commit();

                console.log("–ü–µ—Ä—Å–æ–Ω–∞–∂ —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–∏–π.");
                
                selectedActivities = [];
                hasMultiplier = false;
                showHealOptions = false;
                showPenaltyOptions = false;
                toggleElement(dom.resetModal, false);
                showResetModal = false;
                // isDead, characterBase64, lastActionId –æ–Ω–æ–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ onSnapshot
                showStatusMessage('success', '–ü–µ—Ä—Å–æ–Ω–∞–∂ —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–∏–π!');

            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:", e);
                showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è.');
            } finally {
                setIsSaving(false);
                setButton(dom.confirmResetBtn, { text: '–ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏', disabled: false });
                dom.cancelResetBtn.disabled = false;
                // onSnapshot –æ–Ω–æ–≤–∏—Ç—å UI
            }
        };

        // --- –õ–û–ì–Ü–ö–ê XP ---

        const handleXPUpdate = () => {
            if (isDead) {
                showStatusMessage('warning', '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ü–æ—Ç—Ä—ñ–±–Ω–µ ¬´–®—Ç—É—á–Ω–µ –¥–∏—Ö–∞–Ω–Ω—è¬ª!');
                return;
            }
            if (selectedActivities.length === 0) return;

            let totalXP = selectedActivities.reduce((sum, activityId) => {
                const reward = REWARDS.find(r => r.id === activityId);
                return sum + (reward ? reward.xp : 0);
            }, 0);

            if (hasMultiplier) {
                totalXP *= MULTIPLIER.factor;
            }

            const description = `${selectedActivities.map(id => REWARDS.find(r => r.id === id)?.name || id).join(', ')}` + (hasMultiplier ? ` (√ó${MULTIPLIER.factor})` : '');

            updateGameState(totalXP, 0, `–û—Ç—Ä–∏–º–∞–Ω–æ XP: +${totalXP}. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ: ${description}`, 'update');

            selectedActivities = [];
            hasMultiplier = false;
            // onSnapshot –æ–Ω–æ–≤–∏—Ç—å UI
        };

        const toggleActivity = (id) => {
            if (isDead) return;
            
            if (selectedActivities.includes(id)) {
                selectedActivities = selectedActivities.filter(item => item !== id);
            } else {
                selectedActivities.push(id);
            }
            renderXpInputSection(); // –û–Ω–æ–≤–∏—Ç–∏ –ª–∏—à–µ —Ü—é —Å–µ–∫—Ü—ñ—é
        };

        // --- –õ–û–ì–Ü–ö–ê –ó–î–û–†–û–í'–Ø ---

        const handleHealthChange = (healthChange, xpChange, actionName, type) => {
            if (isDead && healthChange <= 0) { 
                showStatusMessage('warning', '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ë—ñ–ª—å—à–µ —à—Ç—Ä–∞—Ñ—ñ–≤ –Ω–∞–∫–ª–∞–¥–∞—Ç–∏ –Ω–µ –º–æ–∂–Ω–∞.');
                return;
            }
            updateGameState(xpChange, healthChange, `${actionName}: ${healthChange > 0 ? '+' : ''}${healthChange} ‚ù§Ô∏è${xpChange !== 0 ? `, ${xpChange > 0 ? '+' : ''}${xpChange} XP` : ''}`, type);
            showHealOptions = false;
            showPenaltyOptions = false;
            // onSnapshot –æ–Ω–æ–≤–∏—Ç—å UI
        };

        const handleCPR = async () => {
            if (!isDead) return; 
            updateGameState(0, 'SET_TO_ONE', '–û–ø—Ü—ñ—è ¬´–®—Ç—É—á–Ω–µ –¥–∏—Ö–∞–Ω–Ω—è¬ª (42 –∫–º –∑–∞ 2 –¥–Ω—ñ) –≤–∏–∫–æ–Ω–∞–Ω–∞. –ü—É–ø–∫–∞ –æ–∂–∏–ª–∞, –∞–ª–µ –≤–∏—Å–Ω–∞–∂–µ–Ω–∞.', 'heal');
        };
        
        // --- –õ–û–ì–Ü–ö–ê IMAGE UPLOADER ---
        
        const handlePaste = async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (isDead) {
                showStatusMessage('warning', '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ù–µ –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏ —Ñ–æ—Ç–æ!');
                return;
            }
            
            dom.pastePrompt.textContent = '–û–±—Ä–æ–±–ª—è—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...';
            dom.pasteArea.classList.add('bg-indigo-200', 'border-indigo-600');
            showStatusMessage('info', '–û–±—Ä–æ–±–ª—è—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è... ');

            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let imageFile = null;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    imageFile = items[i].getAsFile();
                    break;
                }
            }

            if (imageFile) {
                if (imageFile.size > 1024 * 1024) { // 1–ú–ë
                    showStatusMessage('error', '–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ ( > 1–ú–ë). –°–ø—Ä–æ–±—É–π—Ç–µ –º–µ–Ω—à–µ.');
                } else {
                    try {
                        const base64Data = await fileToBase64(imageFile);
                        await handleSaveBase64(base64Data);
                    } catch (error) {
                        console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó Base64:", error);
                        showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.');
                    }
                }
            } else {
                showStatusMessage('warning', '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É –≤—Å—Ç–∞–≤–ª–µ–Ω–∏—Ö –¥–∞–Ω–∏—Ö.');
            }
            
            dom.pastePrompt.textContent = '–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —Ç—É—Ç —ñ –≤—Å—Ç–∞–≤—Ç–µ (Ctrl+V)';
            dom.pasteArea.classList.remove('bg-indigo-200', 'border-indigo-600');
        };
        
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readDataURL(file);
            });
        };

        // --- –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø UI –¢–ê –ü–û–î–Ü–ô ---

        function initUI() {
            // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö, –∞–ª–µ –¥–∏–Ω–∞–º—ñ—á–Ω–æ –≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö —Å–ø–∏—Å–∫—ñ–≤
            
            // X2 Multiplier
            dom.multiplierLabel.textContent = MULTIPLIER.name;

            // Heal Tasks
            dom.healTasksList.innerHTML = '';
            HEALING_TASKS.forEach(task => {
                const button = document.createElement('button');
                button.className = "flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-pink-500 hover:bg-pink-600 disabled:opacity-50 disabled:cursor-not-allowed w-full";
                button.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> ${task.name}`;
                button.onclick = () => handleHealthChange(1, 0, `–õ—ñ–∫—É–≤–∞–Ω–Ω—è: ${task.name}`, 'heal');
                dom.healTasksList.appendChild(button);
            });

            // Penalty Tasks
            dom.penaltyTasksList.innerHTML = '';
            PENALTIES.forEach(penalty => {
                const button = document.createElement('button');
                button.className = "flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-red-500 hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed w-full";
                button.innerHTML = `<i data-lucide="x-circle" class="w-5 h-5 mr-2"></i> ${penalty.name} (${penalty.health ? penalty.health + ' ‚ù§Ô∏è' : ''} ${penalty.xp ? (penalty.xp > 0 ? '+' : '') + penalty.xp + ' XP' : ''})`;
                button.onclick = () => handleHealthChange(penalty.health, penalty.xp, `–®—Ç—Ä–∞—Ñ: ${penalty.name}`, 'penalty');
                dom.penaltyTasksList.appendChild(button);
            });
            
            // –†–µ–Ω–¥–µ—Ä —ñ–∫–æ–Ω–æ–∫, –¥–æ–¥–∞–Ω–∏—Ö –≤–∏—â–µ
            lucide.createIcons();

            // –ü—Ä–∏–≤'—è–∑–∫–∞ –ø–æ–¥—ñ–π
            
            // Status
            dom.imageContainer.onclick = () => {
                if (!isDead) {
                    showImageInput = !showImageInput;
                    toggleElement(dom.imageUploader, showImageInput);
                    if(showImageInput) dom.pasteArea.focus();
                }
            };
            dom.closeImageUploader.onclick = () => {
                showImageInput = false;
                toggleElement(dom.imageUploader, false);
            };
            dom.pasteArea.onpaste = handlePaste;
            dom.removeImageBtn.onclick = handleRemoveImage;

            // XP
            dom.multiplierCheckbox.onchange = (e) => { hasMultiplier = e.target.checked; };
            dom.addXpBtn.onclick = handleXPUpdate;
            dom.undoBtn.onclick = handleUndoLastAction;

            // Actions
            dom.cprBtn.onclick = handleCPR;
            dom.showHealBtn.onclick = () => {
                showHealOptions = !showHealOptions;
                renderActionButtons();
            };
            dom.showPenaltyBtn.onclick = () => {
                showPenaltyOptions = !showPenaltyOptions;
                renderActionButtons();
            };
            dom.closeHealBtn.onclick = () => { showHealOptions = false; renderActionButtons(); };
            dom.closePenaltyBtn.onclick = () => { showPenaltyOptions = false; renderActionButtons(); };
            
            // Reset
            dom.showResetModalBtn.onclick = () => {
                showResetModal = true;
                toggleElement(dom.resetModal, true);
            };
            dom.cancelResetBtn.onclick = () => {
                showResetModal = false;
                toggleElement(dom.resetModal, false);
            };
            dom.confirmResetBtn.onclick = handleResetCharacter;
        }

        // --- –ì–û–õ–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø (–ó–ê–ü–£–°–ö) ---

        document.addEventListener('DOMContentLoaded', () => {
            initUI(); // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è UI —Ç–∞ –ø–æ–¥—ñ–π
            
            if (firebaseConfig) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            const anonymousUser = await signInAnonymously(auth);
                            userId = anonymousUser.user.uid;
                        }
                        isAuthReady = true;
                        dom.loader.style.display = 'none'; // –°—Ö–æ–≤–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á
                        
                        // –ó–∞–ø—É—Å–∫ —Å–ª—É—Ö–∞—á—ñ–≤ Firestore
                        startFirestoreListeners();
                        renderAll(); // –ü–µ—Ä—à–∏–π —Ä–µ–Ω–¥–µ—Ä
                    });
                } catch (error) {
                    console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase:", error);
                    dom.loader.innerHTML = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.';
                }
            } else {
                console.warn("Firebase config –Ω–µ –Ω–∞–¥–∞–Ω–æ. –î–∞–Ω—ñ –Ω–µ –±—É–¥—É—Ç—å –∑–±–µ—Ä–µ–∂–µ–Ω—ñ.");
                userId = 'anon-local';
                isAuthReady = true;
                dom.loader.style.display = 'none';
                renderAll();
            }
        });
        
        function startFirestoreListeners() {
            if (!db || !userId) return;

            const stateDocRef = doc(db, `artifacts/${appId}/users/${userId}/pupka_game/${GAME_DOC_ID}`);
            const historyColRef = collection(stateDocRef, 'history');

            // Listener –¥–ª—è —Å—Ç–∞–Ω—É
            onSnapshot(stateDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const newHealth = data.health !== undefined && data.health !== null ? data.health : MAX_HEALTH;

                    xp = data.xp || 0;
                    health = newHealth;
                    isDead = newHealth <= 0;
                    characterBase64 = data.characterBase64 || '';
                    lastActionId = data.lastActionId || null;
                } else {
                    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è, —è–∫—â–æ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ —ñ—Å–Ω—É—î
                    xp = 0;
                    health = MAX_HEALTH;
                    isDead = false;
                    characterBase64 = '';
                    lastActionId = null;
                    if (userId !== 'anon-local') {
                        setDoc(stateDocRef, { xp: 0, health: MAX_HEALTH, characterBase64: '', lastActionId: null, createdAt: serverTimestamp() }, { merge: true })
                            .catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å—Ç–∞–Ω—É:", e));
                    }
                }
                renderAll(); // –û–Ω–æ–≤–∏—Ç–∏ –≤–µ—Å—å UI –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
            }, (error) => {
                console.error("–ü–æ–º–∏–ª–∫–∞ onSnapshot (state):", error);
            });

            // Listener –¥–ª—è —ñ—Å—Ç–æ—Ä—ñ—ó
            const q = query(historyColRef, orderBy('timestamp', 'desc'), limit(10));
            onSnapshot(q, (snapshot) => {
                history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHistory(); // –û–Ω–æ–≤–∏—Ç–∏ –ª–∏—à–µ —ñ—Å—Ç–æ—Ä—ñ—é
                renderXpInputSection(); // –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞–Ω –∫–Ω–æ–ø–∫–∏ "Undo"
            }, (error) => {
                console.error("–ü–æ–º–∏–ª–∫–∞ onSnapshot (history):", error);
            });
        }
        
    </script>
</body>
</html>
