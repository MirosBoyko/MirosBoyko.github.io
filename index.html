<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale1.0">
    <!-- 1. –ó–º—ñ–Ω–µ–Ω–æ Title -->
    <title>Pupka Tracker (Firebase Sync)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 2. –î–æ–¥–∞–Ω–æ Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    
    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–ª–∞–≤–Ω–æ—ó –ø–æ—è–≤–∏/–∑–Ω–∏–∫–Ω–µ–Ω–Ω—è */
        .hidden-item {
            display: none;
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }
        .visible-item {
            display: block;
            opacity: 1;
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ */
        #reset-modal.hidden-item { display: none; }
        #reset-modal.visible-item { display: flex; }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å */
        #status-alert.hidden-item { 
            display: none;
            opacity: 0;
            transform: translateX(100%);
        }
        #status-alert.visible-item { 
            display: flex;
            opacity: 1;
            transform: translateX(0);
        }

        /* –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∫–ª—ñ–∫–∞–º –ø—ñ–¥ —á–∞—Å –±–ª–æ–∫—É–≤–∞–Ω–Ω—è */
        .ui-blocked {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8 font-sans">

    <!-- –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="max-w-4xl mx-auto space-y-8">
        
        <!-- –•–µ–¥–µ—Ä —ñ –°—Ç–∞—Ç—É—Å -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- –°–µ–∫—Ü—ñ—è –°—Ç–∞—Ç—É—Å—É (StatusDisplay) -->
            <div class="md:col-span-1">
                <div class="bg-white p-6 rounded-2xl shadow-xl text-center space-y-4">
                    <h1 class="text-3xl font-extrabold text-indigo-700">–ü—É–ø–∫–∞</h1>
                    
                    <!-- Health Display -->
                    <div id="heart-display" class="flex justify-center mb-4 gap-1">
                        <!-- –°–µ—Ä—Ü—è –±—É–¥—É—Ç—å –≤—Å—Ç–∞–≤–ª–µ–Ω—ñ —Å—é–¥–∏ -->
                    </div>

                    <!-- Character Visualization (Pupka Image) -->
                    <div id="image-container" class="w-28 h-28 mx-auto mb-4 rounded-full overflow-hidden shadow-xl border-4 border-indigo-200 transition-all duration-300 transform hover:scale-105 cursor-pointer"
                         role="button"
                         aria-label="–ó–º—ñ–Ω–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ü—É–ø–∫–∏">
                        <img id="pupka-image"
                             src="https://placehold.co/112x112/ff9900/ffffff?text=Pupka" 
                             alt="Pupka Character" 
                             class="w-full h-full object-cover">
                    </div>
                    
                    <!-- –ü–æ–ª–µ –≤–≤–æ–¥—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (ImageUploader) -->
                    <div id="image-uploader" class="hidden-item p-4 mt-4 bg-indigo-50 rounded-xl border border-indigo-300 space-y-3">
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-indigo-800 flex items-center">
                                <i data-lucide="image" class="w-5 h-5 mr-2"></i> –í—Å—Ç–∞–≤–∏—Ç–∏ (Ctrl+V)
                            </h4>
                            <button id="close-image-uploader" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x-circle" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <!-- –ü–æ–ª–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ -->
                        <div id="paste-area"
                             tabindex="0" 
                             class="w-full p-4 h-24 border-2 border-dashed rounded-lg text-center cursor-text transition-all duration-200 bg-white border-gray-300 hover:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <p id="paste-prompt" class="text-gray-500 font-medium mt-2">
                                –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —Ç—É—Ç —ñ –≤—Å—Ç–∞–≤—Ç–µ (Ctrl+V)
                            </p>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è -->
                        <button id="remove-image-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-red-500 hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed w-full">
                            <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>
                            –°–∫–∏–Ω—É—Ç–∏ —Ñ–æ—Ç–æ –ü—É–ø–∫–∏
                        </button>
                    </div>

                    <!-- Evolution Level -->
                    <div class="font-semibold text-lg text-gray-600 pt-4 border-t border-gray-100" id="level-prefix">
                        –†—ñ–≤–µ–Ω—å 1
                    </div>
                    <h2 class="text-2xl font-bold text-indigo-600 mb-2" id="level-name">...</h2>
                    <p class="text-sm italic text-gray-500" id="level-description">...</p>

                    <!-- XP Bar -->
                    <div class="pt-2">
                        <div class="text-sm font-medium text-gray-700 flex justify-between">
                            <span id="xp-current-text">XP: 0</span>
                            <span id="xp-needed-text">–î–æ –ù–∞—Å—Ç. –†—ñ–≤–Ω—è: 101</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 mt-1">
                            <div id="xp-progress-bar"
                                 class="h-4 rounded-full transition-all duration-700 bg-yellow-500"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –°–µ–∫—Ü—ñ—è –î–æ–¥–∞–≤–∞–Ω–Ω—è XP (XpInputSection) -->
            <div class="md:col-span-2">
                <div id="xp-section-content" class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <i data-lucide="zap" class="w-6 h-6 mr-2 text-indigo-600"></i> –î–æ–¥–∞—Ç–∏ XP –∑–∞ –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è
                    </h3>
                    
                    <!-- –ú–Ω–æ–∂–Ω–∏–∫ X2 -->
                    <label class="flex items-center space-x-3 p-3 bg-yellow-50 rounded-lg border border-yellow-300 cursor-pointer transition-all hover:bg-yellow-100">
                        <input id="multiplier-checkbox" 
                               type="checkbox" 
                               class="form-checkbox h-5 w-5 text-indigo-600 rounded">
                        <span id="multiplier-label" class="font-semibold text-yellow-800">...</span>
                    </label>

                    <!-- –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π -->
                    <div id="rewards-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-96 overflow-y-auto pr-2">
                        <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –±—É–¥—É—Ç—å –≤—Å—Ç–∞–≤–ª–µ–Ω—ñ —Å—é–¥–∏ -->
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ –î—ñ—ó XP -->
                    <div class="flex space-x-3 pt-2">
                        <!-- –ö–ù–û–ü–ö–ê –í–Ü–î–ú–Ü–ù–ò / –ö–†–û–ö –ù–ê–ó–ê–î -->
                        <button id="undo-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-orange-500 hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="rotate-ccw" class="w-5 h-5 mr-2"></i>
                            –ö—Ä–æ–∫ –Ω–∞–∑–∞–¥
                        </button>
                        
                        <!-- –ö–ù–û–ü–ö–ê –ó–ê–†–ê–•–£–í–ê–¢–ò XP -->
                        <button id="add-xp-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex-grow">
                            <i data-lucide="chevrons-up" class="w-5 h-5 mr-2"></i>
                            –ó–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ XP
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü—ñ—è –î—ñ–π —Ç–∞ –Ü—Å—Ç–æ—Ä—ñ—è -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- –°–µ–∫—Ü—ñ—è –ö–Ω–æ–ø–æ–∫ –î—ñ–π (ActionButtons) -->
            <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                <h3 class="text-xl font-bold text-gray-800">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ó–¥–æ—Ä–æ–≤'—è–º (‚ù§Ô∏è)</h3>

                <!-- –ó–¥–æ—Ä–æ–≤'—è = 0 (CPR) -->
                <div id="cpr-section" class="hidden-item p-4 bg-red-100 border border-red-400 rounded-xl text-red-800 font-semibold text-center space-y-3">
                    <p class="font-bold text-lg">üíÄ –°–º–µ—Ä—Ç—å –ü—É–ø–∫–∏!</p>
                    <p>–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ ¬´–®—Ç—É—á–Ω–µ –¥–∏—Ö–∞–Ω–Ω—è¬ª!</p>
                    <button id="cpr-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed w-full">
                        <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>
                        42 –∫–º –∑–∞ 2 –¥–Ω—ñ (–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ 1 ‚ù§Ô∏è)
                    </button>
                    <p class="text-sm text-red-600">–Ø–∫—â–æ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–æ, –ü—É–ø–∫–∞ –ø–æ–º–µ—Ä–ª–∞ –Ω–∞–∑–∞–≤–∂–¥–∏.</p>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –î—ñ—ó -->
                <div id="action-buttons-container" class="grid grid-cols-2 gap-3">
                    <button id="show-heal-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-pink-600 hover:bg-pink-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="heart" class="w-5 h-5 mr-2"></i>
                        –õ—ñ–∫—É–≤–∞–Ω–Ω—è (+1 ‚ù§Ô∏è)
                    </button>
                    <button id="show-penalty-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-gray-600 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="x-circle" class="w-5 h-5 mr-2"></i>
                        –®—Ç—Ä–∞—Ñ (‚Äî ‚ù§Ô∏è/XP)
                    </button>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å –õ—ñ–∫—É–≤–∞–Ω–Ω—è -->
                <div id="heal-options" class="hidden-item p-4 bg-pink-50 rounded-xl border border-pink-300 space-y-2">
                    <h4 class="font-semibold text-pink-800">–í–∏–∫–æ–Ω–∞–Ω—ñ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –õ—ñ–∫—É–≤–∞–Ω–Ω—è (+1 ‚ù§Ô∏è):</h4>
                    <div id="heal-tasks-list">
                        <!-- –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –ª—ñ–∫—É–≤–∞–Ω–Ω—è -->
                    </div>
                    <button id="close-heal-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-gray-400 hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed w-full mt-2">
                        –ó–∞–∫—Ä–∏—Ç–∏
                    </button>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å –®—Ç—Ä–∞—Ñ—ñ–≤ -->
                <div id="penalty-options" class="hidden-item p-4 bg-gray-50 rounded-xl border border-gray-300 space-y-2">
                    <h4 class="font-semibold text-gray-800">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –®—Ç—Ä–∞—Ñ:</h4>
                    <div id="penalty-tasks-list">
                        <!-- –®—Ç—Ä–∞—Ñ–∏ -->
                    </div>
                    <button id="close-penalty-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-gray-400 hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed w-full mt-2">
                        –ó–∞–∫—Ä–∏—Ç–∏
                    </button>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –°–∫–∏–¥–∞–Ω–Ω—è/–ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è -->
                <div class="pt-4 border-t border-gray-200">
                    <button id="show-reset-modal-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-red-500 hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed w-full">
                        <i data-lucide="rotate-ccw" class="w-5 h-5 mr-2"></i>
                        –ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–°–∫–∏–Ω—É—Ç–∏ –≤—Å–µ)
                    </button>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü—ñ—è –Ü—Å—Ç–æ—Ä—ñ—ó (HistorySection) -->
            <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4 col-span-1 lg:col-span-2" id="history-section-content">
                <h3 class="text-xl font-bold text-gray-800">–Ü—Å—Ç–æ—Ä—ñ—è –ü—Ä–æ–≥—Ä–µ—Å—É (–û—Å—Ç–∞–Ω–Ω—ñ 10)</h3>
                <div class="max-h-80 overflow-y-auto space-y-2 pr-2" id="history-list">
                    <p class="text-gray-500 italic">–¢—É—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏–º—É—Ç—å—Å—è –≤–∞—à—ñ –¥—ñ—ó.</p>
                </div>
                <!-- 3. –ó–º—ñ–Ω–µ–Ω–æ —Ç–µ–∫—Å—Ç ID -->
                <p class="text-xs text-center text-gray-400">ID –ü—É–ø–∫–∏: <span id="user-id-display">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</span></p>
            </div>

        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –°–∫–∏–¥–∞–Ω–Ω—è (ResetConfirmationModal) -->
    <div id="reset-modal" class="hidden-item fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full space-y-4">
            <h3 class="text-xl font-bold text-red-600">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</h3>
            <p class="text-gray-700">–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ü—É–ø–∫—É?</p>
            <!-- 4. –û–Ω–æ–≤–ª–µ–Ω–æ —Ç–µ–∫—Å—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ -->
            <p class="text-sm text-gray-500">–¶—è –¥—ñ—è —Å–∫–∏–Ω–µ **XP, –ó–¥–æ—Ä–æ–≤'—è** —Ç–∞ **–ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–ª–∏—Ç—å —ñ—Å—Ç–æ—Ä—ñ—é** –∑ —Ö–º–∞—Ä–Ω–æ—ó –±–∞–∑–∏. –¶–µ –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-reset-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-gray-500 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
                <button id="confirm-reset-btn" class="flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="rotate-ccw" class="w-5 h-5 mr-2"></i>
                    <span id="reset-btn-text">–ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏</span>
                </button>
            </div>
        </div>
    </div>

    <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –°—Ç–∞—Ç—É—Å (StatusAlert) -->
    <div id="status-alert" class="hidden-item fixed bottom-4 right-4 z-50 p-4 rounded-xl shadow-lg border-l-4 font-semibold max-w-xs transition-all duration-300">
        <span id="status-alert-icon-container">
            <!-- –Ü–∫–æ–Ω–∫–∞ –±—É–¥–µ —Ç—É—Ç -->
        </span>
        <span id="status-alert-text">...</span>
    </div>

    <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á (Loader) -->
    <div id="loader" class="flex items-center justify-center min-h-screen bg-gray-100 fixed inset-0 z-50">
        <div class="text-indigo-600 text-lg font-semibold flex items-center">
            <i data-lucide="refresh-cw" class="w-6 h-6 mr-3 animate-spin"></i> 
            <!-- 5. –ó–º—ñ–Ω–µ–Ω–æ —Ç–µ–∫—Å—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á–∞ -->
            –ó'—î–¥–Ω–∞–Ω–Ω—è –∑ –ü—É–ø–∫–æ—é —á–µ—Ä–µ–∑ Firebase...
        </div>
    </div>


    <!-- JavaScript -->
    <script> 
        // --------------------------------------------------------
        // !!! 6. –î–û–î–ê–ù–û –í–ê–®–£ –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Æ FIREBASE !!!
        // --------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyCJp0gKk0gPIDclIIc5rgnH9LGo5G6_768",
            authDomain: "pupka-game.firebaseapp.com",
            databaseURL: "https://pupka-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pupka-game",
            storageBucket: "pupka-game.firebasestorage.app",
            messagingSenderId: "672252683379",
            appId: "1:672252683379:web:af9a12a470509805517606"
        };
        // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –¥–ª—è —Ü—ñ—î—ó –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –ü—É–ø–∫–∏ (—Å–ø—ñ–ª—å–Ω–∏–π –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤)
        const PUPKA_ID = "GLOBAL_PUPKA_TRACKER";
        // --------------------------------------------------------


        // --- –ö–û–ù–°–¢–ê–ù–¢–ò –ì–†–ò ---
        // (–ó–∞–ª–∏—à–µ–Ω–æ –±–µ–∑ –∑–º—ñ–Ω –∑ –≤–∞—à–æ–≥–æ —Ñ–∞–π–ª—É)
        const LEVELS = [
          { name: '–ü—É–ø–∫–∞ (–ü–æ—á–∞—Ç–∫–æ–≤–∞ –ú–æ–ª–µ–∫—É–ª–∞)', minXp: 0, maxXp: 100, description: '–ú–∞–ª–µ–Ω—å–∫–∞, –∞–ª–µ –∂–≤–∞–≤–∞ —ñ—Å—Ç–æ—Ç–∞' },
          { name: '–ú—ñ–∫—Ä–æ–æ—Ä–≥–∞–Ω—ñ–∑–º', minXp: 101, maxXp: 250, description: '–ü–æ—á–∏–Ω–∞—î —Ä—É—Ö–∞—Ç–∏—Å—å —ñ —Å–≤—ñ—Ç–∏—Ç–∏—Å—å' },
          { name: '–ö–ª—ñ—Ç–∏–Ω–∫–∞ –ñ–∏—Ç—Ç—è', minXp: 251, maxXp: 500, description: '–ú–∞—î —Å–∏–ª—É –π —Ñ–æ—Ä–º—É' },
          { name: '–ú–∞–ª–µ–Ω—å–∫–µ –ó–≤—ñ—Ä—è—Ç–∫–æ', minXp: 501, maxXp: 900, description: '–ü–æ—á–∏–Ω–∞—î –ø—Ä–æ—è–≤–ª—è—Ç–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä' },
          { name: '–õ—é–¥–∏–Ω–∫–∞-–ü—É–ø–∫–∞', minXp: 901, maxXp: 1500, description: '–°–ø—Ä–∞–≤–∂–Ω—ñ–π –≥–µ—Ä–æ–π ‚Äî –¥–æ—Å—è–≥ –≥–∞—Ä–º–æ–Ω—ñ—ó' },
          { name: '–í–∏—â–∞ —Ñ–æ—Ä–º–∞ (–ù–æ–≤–∏–π –°–≤—ñ—Ç)', minXp: 1501, maxXp: 9999, description: '–î–æ—Å—è–≥–Ω—É—Ç–∞ –Ω–æ–≤–∞, –Ω–µ–≤—ñ–¥–æ–º–∞ —Ñ–æ—Ä–º–∞!' },
        ];
        const MAX_HEALTH = 7;
        const REWARDS = [
          { id: 'base', name: 'üèÉ‚Äç‚ôÇÔ∏è –ë–∞–∑–æ–≤–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è (20+ —Ö–≤)', xp: 10 },
          { id: 'rain', name: 'üåßÔ∏è –ü–æ–≥–∞–Ω–∞ –ø–æ–≥–æ–¥–∞ / –î–æ—â', xp: 5, isBonus: true },
          { id: 'run5k', name: 'üèÉ‚Äç‚ôÄÔ∏è 5 –∫–º –±—ñ–≥—É', xp: 10 },
          { id: 'run10k', name: 'üèÉ 10 –∫–º –±—ñ–≥—É', xp: 25 },
          { id: 'run15k', name: 'ü¶ø 15 –∫–º –±—ñ–≥—É', xp: 50 },
          { id: 'squat150', name: 'üèãÔ∏è 150 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 10 },
          { id: 'squat300', name: 'üèãÔ∏è‚Äç‚ôÇÔ∏è 300 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 25 },
          { id: 'squat600', name: 'üèãÔ∏è‚Äç‚ôÄÔ∏è 600 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 50 },
          { id: 'squat1000', name: 'üí™ 1000 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 100 },
          { id: 'pullup50', name: 'ü™ú 50 –ø—ñ–¥—Ç—è–≥—É–≤–∞–Ω—å (–¥–ª—è –Ω—å–æ–≥–æ)', xp: 5 },
          { id: 'pullup100', name: 'üßó 100 –ø—ñ–¥—Ç—è–≥—É–≤–∞–Ω—å (–¥–ª—è –Ω—å–æ–≥–æ)', xp: 10 },
          { id: 'menstrual', name: 'ü©∏ –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –º—ñ—Å—è—á–Ω–∏—Ö (–¥–ª—è –Ω–µ—ó)', xp: 5, isBonus: true },
          { id: 'walk3k', name: 'üö∂ –ü—Ä–æ–≥—É–ª—è–Ω–∫–∞ 3+ –∫–º', xp: 5 },
          { id: 'yoga', name: 'üßò –†–æ–∑—Ç—è–∂–∫–∞ / –ô–æ–≥–∞ (30 —Ö–≤)', xp: 10 },
          { id: 'early', name: 'üåÖ –†–∞–Ω–∫–æ–≤–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –¥–æ 8:00', xp: 5, isBonus: true },
          { id: 'fasted', name: 'üçΩÔ∏è –ë—ñ–≥ –Ω–∞—Ç—â–µ—Å–µ—Ä—Ü–µ', xp: 5, isBonus: true },
          { id: 'together', name: 'ü§ù –°–ø—ñ–ª—å–Ω–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è', xp: 10, isBonus: true },
          { id: 'reading', name: 'üìö –ß–∏—Ç–∞–Ω–Ω—è –∫–Ω–∏–≥–∏ (30 —Ö–≤)', xp: 5 },
        ];
        const MULTIPLIER = { id: 'gymX2', name: '‚≠ê –î–æ–¥–∞—Ç–∫–æ–≤–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è —É —Å–ø–æ—Ä—Ç–∑–∞–ª—ñ (√ó2 XP)', factor: 2 };
        const HEALING_TASKS = [
            { id: 'heal_squat500', name: 'üèãÔ∏è‚Äç‚ôÇÔ∏è 500 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å' },
            { id: 'heal_water', name: 'üíß –ü–∏—Ç–∏ 2.5 –ª –≤–æ–¥–∏ (3 –¥–Ω—ñ –ø–æ—Å–ø—ñ–ª—å)' },
            { id: 'heal_meditate', name: 'üßò –†–æ–∑—Ç—è–∂–∫–∞ 30 —Ö–≤ (5 –¥–Ω—ñ–≤ –ø–æ—Å–ø—ñ–ª—å)' }, 
            { id: 'heal_diet', name: 'üö´ –¢–∏–∂–¥–µ–Ω—å –±–µ–∑ —Å–æ–ª–æ–¥–∫–æ–≥–æ/—Ñ–∞—Å—Ç—Ñ—É–¥—É (7 –¥–Ω—ñ–≤)' },
            { id: 'heal_nodopamine', name: 'üìµ 24 –≥–æ–¥–∏–Ω–∏ –±–µ–∑ –ª–µ–≥–∫–æ–≥–æ –¥–æ—Ñ–∞–º—ñ–Ω—É (–°–æ—Ü–º–µ—Ä–µ–∂—ñ/–Ü–≥—Ä–∏)' },
        ];
        const PENALTIES = [
            { id: 'skip', name: '–ü—Ä–æ–ø—É—Å–∫ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è', health: -1, xp: 0 },
            { id: 'no_evolve', name: '–î–≤–∞ —Ç–∏–∂–Ω—ñ –±–µ–∑ –µ–≤–æ–ª—é—Ü—ñ—ó', health: -2, xp: 0 },
            { id: 'no_circle', name: '–ë–µ–∑ "–∫—Ä—É–∂–µ—á–∫—É" (–≤—ñ–¥–µ–æ–∑–≤—ñ—Ç—É)', health: 0, xp: -10 },
        ];
        
        const DEFAULT_PUPKA_IMAGE_URL = 'https://placehold.co/112x112/ff9900/ffffff?text=Pupka';
        // 7. –í–∏–¥–∞–ª–µ–Ω–æ LOCAL_STORAGE_KEY
        // const LOCAL_STORAGE_KEY = 'pupkaTrackerState'; 

        // --- –ì–õ–û–ë–ê–õ–¨–ù–ò–ô –°–¢–ê–ù ---
        let isDead = false;
        let isSaving = false;
        let xp = 0;
        let health = MAX_HEALTH;
        let history = [];
        let characterBase64 = '';
        let lastActionId = null;

        // –°—Ç–∞–Ω UI
        let showImageInput = false;
        let showHealOptions = false;
        let showPenaltyOptions = false;
        let showResetModal = false;
        let selectedActivities = [];
        let hasMultiplier = false;
        let statusMessageTimer = null;

        // --- 8. –î–û–î–ê–ù–û FIREBASE –ó–ú–Ü–ù–ù–Ü ---
        let dbRef;
        let isInitialized = false;

        // --- DOM –ï–õ–ï–ú–ï–ù–¢–ò (–æ—Ç—Ä–∏–º—É—î–º–æ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM) ---
        let dom = {};

        // --- –°–ï–ô–§–ï–†–ò/–ë–õ–û–ö–£–í–ê–ù–ù–Ø UI ---
        function setIsSaving(saving) {
            isSaving = saving;
        }
        
        // --- –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á UI ---

        function runLucide() {
            // 9. –î–û–î–ê–ù–û TRY...CATCH (–∑–∞ –≤–∞—à–∏–º –ø—Ä–æ—Ö–∞–Ω–Ω—è–º)
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                     lucide.createIcons();
                }
            } catch (e) {
                console.warn("–ü–æ–º–∏–ª–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É —ñ–∫–æ–Ω–æ–∫ Lucide.", e);
            }
        }
        
        function toggleElement(el, show) {
            if (show) {
                el.classList.remove('hidden-item');
                el.classList.add('visible-item');
            } else {
                el.classList.remove('visible-item');
                el.classList.add('hidden-item');
            }
        }

        function setButton(button, { text, disabled }) {
            if (text) button.innerText = text;
            button.disabled = disabled;
        }

        function showStatusMessage(type, text) {
            // –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω
            if (statusMessageTimer) clearTimeout(statusMessageTimer);

            dom.statusAlertText.textContent = text;
            
            let colorClass, iconName;
            switch (type) {
                case 'success':
                    colorClass = 'bg-green-100 text-green-800 border-green-400';
                    iconName = 'check-circle';
                    break;
                case 'error':
                    colorClass = 'bg-red-100 text-red-800 border-red-400';
                    iconName = 'x-circle';
                    break;
                case 'warning':
                    colorClass = 'bg-yellow-100 text-yellow-800 border-yellow-400';
                    iconName = 'zap';
                    break;
                case 'info':
                default:
                    colorClass = 'bg-blue-100 text-blue-800 border-blue-400';
                    iconName = 'refresh-cw';
                    break;
            }
            
            dom.statusAlert.className = `fixed bottom-4 right-4 z-50 p-4 rounded-xl shadow-lg border-l-4 font-semibold max-w-xs transition-all duration-300 ${colorClass} visible-item`;
            
            const iconEl = document.createElement('i');
            iconEl.setAttribute('data-lucide', iconName);
            iconEl.className = `w-5 h-5 mr-3 ${type === 'info' ? 'animate-spin' : ''}`;
            dom.statusAlertIconContainer.innerHTML = '';
            dom.statusAlertIconContainer.appendChild(iconEl);
            runLucide();

            statusMessageTimer = setTimeout(() => {
                toggleElement(dom.statusAlert, false);
            }, 5000);
        }

        // --- –§–£–ù–ö–¶–Ü–á –†–ï–ù–î–ï–†–£ (–û–ù–û–í–õ–ï–ù–ù–Ø UI) ---

        function renderHeartDisplay() {
            dom.heartDisplay.innerHTML = '';
            for (let i = 0; i < MAX_HEALTH; i++) {
                const heart = document.createElement('i');
                heart.setAttribute('data-lucide', 'heart');
                heart.className = `w-6 h-6 transition-colors duration-300 ${i < health ? 'fill-red-500 text-red-500' : 'fill-gray-300 text-gray-400'}`;
                dom.heartDisplay.appendChild(heart);
            }
            runLucide();
        }

        function renderStatusDisplay() {
            renderHeartDisplay();
            
            dom.pupkaImage.src = characterBase64 || DEFAULT_PUPKA_IMAGE_URL;
            dom.pupkaImage.classList.remove('object-contain', 'p-2');
            dom.pupkaImage.classList.add('object-cover');
            
            dom.removeImageBtn.disabled = isSaving || !characterBase64 || isDead;

            const currentLevel = LEVELS.find(l => xp >= l.minXp && xp <= l.maxXp) || LEVELS[0];
            const nextLevel = LEVELS[LEVELS.indexOf(currentLevel) + 1] || currentLevel;

            dom.levelPrefix.textContent = `–†—ñ–≤–µ–Ω—å ${LEVELS.indexOf(currentLevel) + 1}`;
            dom.levelName.textContent = currentLevel.name;
            dom.levelDescription.textContent = currentLevel.description;

            dom.xpCurrentText.textContent = `XP: ${xp}`;
            
            let xpToNext, progress;
            if (currentLevel.maxXp === nextLevel.maxXp) {
                xpToNext = 0;
                progress = 100;
            } else {
                const range = nextLevel.minXp - currentLevel.minXp;
                const progressInLevel = xp - currentLevel.minXp;
                progress = Math.min(100, (progressInLevel / range) * 100);
                xpToNext = nextLevel.minXp - xp;
                if (xp >= nextLevel.minXp) {
                   xpToNext = nextLevel.maxXp - xp;
                }
            }

            dom.xpNeededText.textContent = xpToNext > 0 ? `–î–æ –ù–∞—Å—Ç. –†—ñ–≤–Ω—è: ${xpToNext}` : 'MAX';
            dom.xpProgressBar.style.width = `${progress}%`;
            dom.xpProgressBar.className = `h-4 rounded-full transition-all duration-700 ${progress >= 100 ? 'bg-green-500' : 'bg-yellow-500'}`;
        }
        
        function renderXpInputSection() {
            dom.rewardsList.innerHTML = '';
            REWARDS.forEach(reward => {
                let rewardName = reward.name;
                
                const isSelected = selectedActivities.includes(reward.id);
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border cursor-pointer transition-all ${
                  isSelected 
                    ? 'bg-indigo-100 border-indigo-500 shadow-md' 
                    : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                }`;
                div.innerHTML = `
                    <div class="font-medium text-gray-700">${rewardName}</div>
                    <div class="text-sm font-bold ${reward.isBonus ? 'text-green-600' : 'text-indigo-600'}">+${reward.xp} XP</div>
                `;
                div.onclick = () => toggleActivity(reward.id);
                dom.rewardsList.appendChild(div);
            });

            dom.multiplierLabel.textContent = MULTIPLIER.name;
            dom.multiplierCheckbox.checked = hasMultiplier;
            dom.addXpBtn.disabled = selectedActivities.length === 0 || isSaving || isDead;
            dom.undoBtn.disabled = !lastActionId || isSaving || isDead;
            
            dom.multiplierCheckbox.onchange = (e) => { 
                hasMultiplier = e.target.checked; 
                renderXpInputSection();
            };
        }

        function renderActionButtons() {
            toggleElement(dom.cprSection, isDead);
            
            if (isDead) {
                dom.actionButtonsContainer.classList.add('opacity-50', 'pointer-events-none');
                toggleElement(dom.healOptions, false);
                toggleElement(dom.penaltyOptions, false);
                showHealOptions = false;
                showPenaltyOptions = false;
            } else {
                dom.actionButtonsContainer.classList.remove('opacity-50', 'pointer-events-none');
            }
            
            dom.cprBtn.disabled = isSaving;
            dom.showHealBtn.disabled = isSaving || isDead || health === MAX_HEALTH;
            dom.showPenaltyBtn.disabled = isSaving || isDead;

            toggleElement(dom.healOptions, showHealOptions && !isDead);
            toggleElement(dom.penaltyOptions, showPenaltyOptions && !isDead);
        }

        function renderHistory() {
            if (history.length === 0) {
                dom.historyList.innerHTML = '<p class="text-gray-500 italic">–¢—É—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏–º—É—Ç—å—Å—è –≤–∞—à—ñ –¥—ñ—ó.</p>';
                return;
            }

            dom.historyList.innerHTML = '';
            history.forEach(item => {
                const healthStatus = item.details?.endHealth !== undefined && item.details.endHealth !== null
                    ? ` (${item.details.endHealth}/${MAX_HEALTH} ‚ù§Ô∏è)`
                    : '';
                const isLastAction = lastActionId === item.id;
                
                // 10. –û–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ —á–∞—Å—É –¥–ª—è Firebase (–∑–∞–º—ñ—Å—Ç—å localStorage ID)
                const timestamp = item.timestamp 
                    ? new Date(item.timestamp).toLocaleTimeString('uk-UA', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) 
                    : '...';

                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border-l-4 shadow-sm flex justify-between items-center transition-all duration-300 ${
                    isLastAction 
                        ? 'border-orange-500 bg-orange-100' 
                        : 'border-indigo-500 bg-gray-50'
                }`;
                
                div.innerHTML = `
                    <span class="text-gray-700 font-medium break-words w-4/5">
                        ${isLastAction ? '<span class="font-extrabold text-orange-700 mr-1">[–û–°–¢–ê–ù–ù–Ø]</span>' : ''}
                        ${item.details?.description || item.type}
                        <span class="font-bold text-indigo-600">${healthStatus}</span>
                    </span>
                    <span class="text-xs text-gray-500 whitespace-nowrap flex items-center">
                      <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                      ${timestamp}
                    </span>
                `;
                dom.historyList.appendChild(div);
            });
            runLucide();
        }

        function renderAll() {
            // 11. –î–û–î–ê–ù–û TRY...CATCH (–∑–∞ –≤–∞—à–∏–º –ø—Ä–æ—Ö–∞–Ω–Ω—è–º)
            try {
                renderStatusDisplay();
                renderXpInputSection();
                renderActionButtons();
                renderHistory();
                
                const uiSections = [dom.xpSectionContent, dom.actionButtonsContainer, dom.historySectionContent, dom.imageContainer];
                const blockClass = 'ui-blocked';
                
                if (isDead) {
                    uiSections.forEach(el => el.classList.add(blockClass));
                    dom.imageContainer.classList.add('opacity-70', 'cursor-not-allowed');
                    dom.imageContainer.classList.remove('hover:scale-105', 'cursor-pointer');
                } else {
                    uiSections.forEach(el => el.classList.remove(blockClass));
                     dom.imageContainer.classList.remove('opacity-70', 'cursor-not-allowed');
                     dom.imageContainer.classList.add('hover:scale-105', 'cursor-pointer');
                }
                
                if (isDead) {
                    dom.pasteArea.classList.add('opacity-50', 'cursor-not-allowed');
                    dom.pasteArea.style.pointerEvents = 'none';
                    dom.removeImageBtn.disabled = true;
                    dom.closeImageUploader.disabled = true;
                } else {
                    dom.pasteArea.classList.remove('opacity-50', 'cursor-not-allowed');
                    dom.pasteArea.style.pointerEvents = 'auto';
                    dom.removeImageBtn.disabled = isSaving || !characterBase64;
                    dom.closeImageUploader.disabled = false;
                }

                // 12. –û–Ω–æ–≤–ª–µ–Ω–æ ID
                dom.userIdDisplay.textContent = PUPKA_ID;

            } catch (error) {
                 console.error("–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –≤ renderAll:", error);
                 showStatusMessage('error', '–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ UI. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.');
            }
        }

        // --- 13. –õ–û–ì–Ü–ö–ê FIREBASE (–ó–ê–ú–Ü–ù–ê LOCALSTORAGE) ---

        // 13a. –í–∏–¥–∞–ª–µ–Ω–æ 'loadStateFromLocalStorage'
        // 13b. –í–∏–¥–∞–ª–µ–Ω–æ 'saveStateToLocalStorage'
        // 13c. –í–∏–¥–∞–ª–µ–Ω–æ 'addHistoryEntry'

        function initFirebase() {
            // –î–û–î–ê–ù–û TRY...CATCH
            try {
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –∫–ª—é—á—ñ –±—É–ª–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω—ñ
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("AIzaSy") === false) {
                    showStatusMessage('error', '–ö–ª—é—á—ñ Firebase –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ! –í—Å—Ç–∞–≤—Ç–µ –≤–∞—à—ñ –∫–ª—é—á—ñ –≤ –∫–æ–¥.');
                    if (dom.loader) dom.loader.style.display = 'none';
                    return;
                }
                
                firebase.initializeApp(firebaseConfig);
                dbRef = firebase.database().ref('pupkas').child(PUPKA_ID);
                
                // .on('value') - —Ü–µ —Å–ª—É—Ö–∞—á, —è–∫–∏–π —Å–ø—Ä–∞—Ü—å–æ–≤—É—î –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
                // —ñ –ø—Ä–∏ –∫–æ–∂–Ω—ñ–π –∑–º—ñ–Ω—ñ –¥–∞–Ω–∏—Ö —É –±–∞–∑—ñ
                dbRef.on('value', (snapshot) => {
                    syncStateFromFirebase(snapshot);
                    if (!isInitialized) {
                        isInitialized = true;
                        // –ü–µ—Ä—à–∏–π —Ä–µ–Ω–¥–µ—Ä –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
                        renderAll(); 
                    }
                }, (error) => {
                    // –¶—è —Ñ—É–Ω–∫—Ü—ñ—è —Å–ø—Ä–∞—Ü—é—î, —è–∫—â–æ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–ø–µ–∫–∏ –∑–∞–±–æ—Ä–æ–Ω—è—é—Ç—å —á–∏—Ç–∞–Ω–Ω—è
                    console.error("Firebase Read Failed:", error);
                    showStatusMessage('error', '–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ Firebase. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–ø–µ–∫–∏.');
                    if (dom.loader) dom.loader.style.display = 'none';
                });

            } catch (e) {
                 console.error("Firebase Init Failed:", e);
                 showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ –∫–ª—é—á—ñ.');
                 if (dom.loader) dom.loader.style.display = 'none';
            }
        }

        function syncStateFromFirebase(snapshot) {
            // –î–û–î–ê–ù–û TRY...CATCH
            try {
                const data = snapshot.val();
                
                if (!data) {
                    // –Ø–∫—â–æ –¥–∞–Ω–∏—Ö –Ω–µ–º–∞—î (–ø–µ—Ä—à–∏–π –∑–∞–ø—É—Å–∫), —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ
                    xp = 0;
                    health = MAX_HEALTH;
                    history = [];
                    characterBase64 = '';
                    lastActionId = null;
                    isDead = false;
                } else {
                    // –û–Ω–æ–≤–ª—é—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
                    xp = data.xp || 0;
                    health = data.health !== undefined && data.health !== null ? data.health : MAX_HEALTH;
                    characterBase64 = data.characterBase64 || '';
                    
                    history = [];
                    if (data.history) {
                        // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –æ–±'—î–∫—Ç Firebase –≤ –º–∞—Å–∏–≤
                        history = Object.keys(data.history).map(key => ({
                            ...data.history[key],
                            id: key // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–ª—é—á Firebase —è–∫ ID –¥—ñ—ó
                        })).sort((a, b) => b.timestamp - a.timestamp).slice(0, 10);
                    }
                    
                    lastActionId = data.lastActionId || null;
                    isDead = (health <= 0);
                }

                // –û–Ω–æ–≤–ª—é—î–º–æ UI, —è–∫—â–æ –≤–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ
                // (–ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É —Ü–µ –≤–∏–∫–ª–∏—á–µ renderAll() –≤ initFirebase)
                if (isInitialized) {
                     renderAll();
                }
            
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –≤ syncStateFromFirebase:", e);
                showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö –∑ —Ö–º–∞—Ä–∏.');
            } finally {
                // !!! –¶–ï –ö–õ–Æ–ß–û–í–ò–ô –§–Ü–ö–°: 
                // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á —Ç—É—Ç, —â–æ–± –≤—ñ–Ω –∑–Ω–∏–∫,
                // –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ renderAll() –∞–±–æ syncState() –≤–∏–¥–∞—Å—Ç—å –ø–æ–º–∏–ª–∫—É.
                if (dom.loader) dom.loader.style.display = 'none';
            }
        }

        async function updateGameState(xpChange, healthUpdate, description, type) {
            if (isSaving || !dbRef) return;
            setIsSaving(true);
            
            // –î–û–î–ê–ù–û TRY...CATCH
            try {
                // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É (—â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∫–æ–ª—ñ–∑—ñ–π —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó)
                // –ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—ñ 'xp' —ñ 'health', —è–∫—ñ –≤–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ
                
                let currentHealth = health;
                
                let calculatedHealth;
                if (healthUpdate === 'SET_TO_ONE' && currentHealth <= 0) {
                    calculatedHealth = 1;
                } else if (typeof healthUpdate === 'number') {
                    calculatedHealth = Math.min(MAX_HEALTH, Math.max(0, currentHealth + healthUpdate));
                } else {
                    calculatedHealth = currentHealth;
                }

                const calculatedXp = Math.max(0, xp + xpChange);
                
                // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Å —ñ—Å—Ç–æ—Ä—ñ—ó
                const newHistoryEntry = {
                    type: type,
                    details: { xpChange: xpChange, healthChange: healthUpdate, description: description, endHealth: calculatedHealth },
                    timestamp: firebase.database.ServerValue.TIMESTAMP // –°–ø–µ—Ü—ñ–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è Firebase
                };
                
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –≤ –±–∞–∑—É —ñ –æ—Ç—Ä–∏–º—É—î–º–æ —ó—ó —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á
                const newHistoryRef = dbRef.child('history').push(newHistoryEntry);
                const newHistoryId = newHistoryRef.key;
                
                // –ì–æ—Ç—É—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
                const updates = {
                    xp: calculatedXp,
                    health: calculatedHealth,
                    lastActionId: newHistoryId // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–ª—é—á –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –¥—ñ—ó
                };

                // –í–∏–∫–æ–Ω—É—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
                await dbRef.update(updates);
                
                // (–ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ renderAll(), .on('value') –∑—Ä–æ–±–∏—Ç—å —Ü–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)
                showStatusMessage('success', `–£—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ: ${description}`);
                
            } catch (error) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è Firebase:", error);
                showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∑ —Ö–º–∞—Ä–æ—é.');
            } finally {
                setIsSaving(false);
            }
        };

        async function handleUndoLastAction() {
            if (!lastActionId || isSaving || !dbRef) {
                showStatusMessage('warning', '–ù–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏: –Ω–µ–º–∞—î –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –¥—ñ—ó –∞–±–æ —Å–∏—Å—Ç–µ–º–∞ –∑–∞–π–Ω—è—Ç–∞.');
                return;
            }
             
            setIsSaving(true);

            // –î–û–î–ê–ù–û TRY...CATCH
            try {
                // –û—Ç—Ä–∏–º—É—î–º–æ –∑–Ω—ñ–º–æ–∫ *–æ–¥–∏–Ω —Ä–∞–∑*, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ —É–º–æ–≤ –≥–æ–Ω–∫–∏
                const snapshot = await dbRef.once('value');
                const data = snapshot.val();
                
                if (!data || !data.history) throw new Error("No data or history found.");
                
                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –¥—ñ—é, —è–∫—É —Ç—Ä–µ–±–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏, –∑–∞ —ó—ó –∫–ª—é—á–µ–º
                const entryToUndo = data.history[lastActionId];
                
                if (!entryToUndo) {
                    showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞: –∑–∞–ø–∏—Å —ñ—Å—Ç–æ—Ä—ñ—ó –¥–ª—è –≤—ñ–¥–º—ñ–Ω–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ —Ö–º–∞—Ä—ñ.');
                    await dbRef.update({ lastActionId: null }); // –°–∫–∏–¥–∞—î–º–æ, —è–∫—â–æ ID –Ω–µ–≤—ñ—Ä–Ω–∏–π
                    return;
                }
                
                const details = entryToUndo.details || {};
                const undoneXpChange = details.xpChange ? -details.xpChange : 0;
                let undoneHealthChange = 0;
                
                if (typeof details.healthChange === 'number') {
                    undoneHealthChange = -details.healthChange;
                } else if (details.healthChange === 'SET_TO_ONE') {
                    showStatusMessage('error', '–í—ñ–¥–º—ñ–Ω–∞ ¬´–®—Ç—É—á–Ω–æ–≥–æ –¥–∏—Ö–∞–Ω–Ω—è¬ª (CPR) –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è.');
                    return; // –í–∏—Ö–æ–¥–∏–º–æ, –Ω–µ –∑–Ω—ñ–º–∞—é—á–∏ isSaving
                }
                
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –∑ data
                const newXp = Math.max(0, (data.xp || 0) + undoneXpChange);
                const currentHealth = (data.health !== undefined && data.health !== null) ? data.health : MAX_HEALTH;
                const newHealth = Math.min(MAX_HEALTH, Math.max(0, currentHealth + undoneHealthChange));
                
                // –ì–æ—Ç—É—î–º–æ "–∞—Ç–æ–º–Ω–µ" –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: –≤–∏–¥–∞–ª—è—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é —Ç–∞ –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω
                const updates = {};
                updates[`history/${lastActionId}`] = null; // –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É —ñ—Å—Ç–æ—Ä—ñ—ó
                updates['xp'] = newXp;
                updates['health'] = newHealth;
                updates['lastActionId'] = null; // –û—á–∏—â–∞—î–º–æ ID –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –¥—ñ—ó

                await dbRef.update(updates);
                
                showStatusMessage('success', `–î—ñ—è —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–º—ñ–Ω–µ–Ω–∞: ${details.description || '–Ω–µ–≤—ñ–¥–æ–º–∞ –¥—ñ—è'}`);
                
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–º—ñ–Ω–∏:", e);
                showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–º—ñ–Ω–∏ –¥—ñ—ó.');
            } finally {
                setIsSaving(false);
                // (renderAll() –≤–∏–∫–ª–∏—á–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)
            }
        };

        async function handleSaveBase64(base64) {
            if (isDead) {
                showStatusMessage('warning', '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ù–µ –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏ —Ñ–æ—Ç–æ!');
                return;
            }
            if (isSaving || !dbRef) return;
            
            setIsSaving(true);
            showStatusMessage('info', '–ó–±–µ—Ä—ñ–≥–∞—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...');

            // –î–û–î–ê–ù–û TRY...CATCH
            try {
                // –û–Ω–æ–≤–ª—é—î–º–æ –ª–∏—à–µ –ø–æ–ª–µ characterBase64
                await dbRef.update({ characterBase64: base64 });
                showStatusMessage('success', '–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ü—É–ø–∫–∏ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
            } catch (error) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:", error);
                showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤ —Ö–º–∞—Ä—ñ.');
            } finally {
                setIsSaving(false);
                toggleElement(dom.imageUploader, false);
                showImageInput = false;
                // (renderAll() –≤–∏–∫–ª–∏—á–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)
            }
        };

        function handleRemoveImage() {
            // –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –Ω–µ –∑–º—ñ–Ω—é—î—Ç—å—Å—è
            if (isDead) {
                showStatusMessage('warning', '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ù–µ –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏ —Ñ–æ—Ç–æ!');
                return;
            }
            handleSaveBase64(''); 
            toggleElement(dom.imageUploader, false);
            showImageInput = false;
        };

        async function handleResetCharacter() {
            if (isSaving || !dbRef) return;

            setIsSaving(true);
            setButton(dom.confirmResetBtn, { text: '–°–∫–∏–¥–∞—é...', disabled: true });
            dom.cancelResetBtn.disabled = true;

            // –î–û–î–ê–ù–û TRY...CATCH
            try {
                // –ì–æ—Ç—É—î–º–æ –ø–æ–≤–Ω–∏–π –æ–±'—î–∫—Ç –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è
                const updates = {
                    xp: 0,
                    health: MAX_HEALTH,
                    characterBase64: '',
                    lastActionId: null,
                    history: null // –ü–æ–≤–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
                };

                await dbRef.set(updates); // .set() –ø–æ–≤–Ω—ñ—Å—Ç—é –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î –¥–∞–Ω—ñ
                
                // –õ–æ–∫–∞–ª—å–Ω–æ —Å–∫–∏–¥–∞—î–º–æ UI
                selectedActivities = [];
                hasMultiplier = false;
                showHealOptions = false;
                showPenaltyOptions = false;
                toggleElement(dom.resetModal, false);
                showResetModal = false;

                showStatusMessage('success', '–ü–µ—Ä—Å–æ–Ω–∞–∂ —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–∏–π!');

            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:", e);
                showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.');
            } finally {
                setIsSaving(false);
                setButton(dom.confirmResetBtn, { text: '–ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏', disabled: false });
                dom.cancelResetBtn.disabled = false;
                // (renderAll() –≤–∏–∫–ª–∏—á–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)
            }
        };

        // --- –õ–û–ì–Ü–ö–ê XP (–Ω–µ –∑–º—ñ–Ω—é—î—Ç—å—Å—è, –≤–∏–∫–ª–∏–∫–∞—î updateGameState) ---

        const handleXPUpdate = () => {
            if (isDead) {
                showStatusMessage('warning', '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ü–æ—Ç—Ä—ñ–±–Ω–µ ¬´–®—Ç—É—á–Ω–µ –¥–∏—Ö–∞–Ω–Ω—è¬ª!');
                return;
            }
            if (selectedActivities.length === 0) {
                 showStatusMessage('warning', '–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ XP.');
                 return;
            }

            let totalXP = selectedActivities.reduce((sum, activityId) => {
                const reward = REWARDS.find(r => r.id === activityId);
                return sum + (reward ? reward.xp : 0);
            }, 0);

            if (hasMultiplier) {
                totalXP *= MULTIPLIER.factor;
            }

            const description = `${selectedActivities.map(id => REWARDS.find(r => r.id === id)?.name || id).join(', ')}` + (hasMultiplier ? ` (√ó${MULTIPLIER.factor})` : '');

            // –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é Firebase
            updateGameState(totalXP, 0, `–û—Ç—Ä–∏–º–∞–Ω–æ XP: +${totalXP}. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ: ${description}`, 'update');

            // –°–∫–∏–¥–∞—î–º–æ UI –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –º–∏—Ç—Ç—î–≤–æ–≥–æ –≤—ñ–¥–≥—É–∫—É
            selectedActivities = [];
            hasMultiplier = false;
            renderXpInputSection();
        };

        const toggleActivity = (id) => {
            if (isDead) return;
            
            if (selectedActivities.includes(id)) {
                selectedActivities = selectedActivities.filter(item => item !== id);
            } else {
                selectedActivities.push(id);
            }
            renderXpInputSection();
        };

        // --- –õ–û–ì–Ü–ö–ê –ó–î–û–†–û–í'–Ø (–Ω–µ –∑–º—ñ–Ω—é—î—Ç—å—Å—è, –≤–∏–∫–ª–∏–∫–∞—î updateGameState) ---

        const handleHealthChange = (healthChange, xpChange, actionName, type) => {
            if (isDead && healthChange <= 0) { 
                showStatusMessage('warning', '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ë—ñ–ª—å—à–µ —à—Ç—Ä–∞—Ñ—ñ–≤ –Ω–∞–∫–ª–∞–¥–∞—Ç–∏ –Ω–µ –º–æ–∂–Ω–∞.');
                return;
            }
            if (healthChange > 0 && health === MAX_HEALTH) {
                showStatusMessage('info', '–ó–¥–æ—Ä–æ–≤\'—è –ø–æ–≤–Ω–µ. –õ—ñ–∫—É–≤–∞–Ω–Ω—è –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–µ.');
                return;
            }
            
            // –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é Firebase
            updateGameState(xpChange, healthChange, `${actionName}: ${healthChange > 0 ? '+' : ''}${healthChange} ‚ù§Ô∏è${xpChange !== 0 ? `, ${xpChange > 0 ? '+' : ''}${xpChange} XP` : ''}`, type);
            
            // –°–∫–∏–¥–∞—î–º–æ UI –ª–æ–∫–∞–ª—å–Ω–æ
            showHealOptions = false;
            showPenaltyOptions = false;
            renderActionButtons();
        };

        const handleCPR = () => {
            if (!isDead) return; 
            // –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é Firebase
            updateGameState(0, 'SET_TO_ONE', '–û–ø—Ü—ñ—è ¬´–®—Ç—É—á–Ω–µ –¥–∏—Ö–∞–Ω–Ω—è¬ª (42 –∫–º –∑–∞ 2 –¥–Ω—ñ) –≤–∏–∫–æ–Ω–∞–Ω–∞. –ü—É–ø–∫–∞ –æ–∂–∏–ª–∞, –∞–ª–µ –≤–∏—Å–Ω–∞–∂–µ–Ω–∞.', 'heal');
        };
        
        // --- –õ–û–ì–Ü–ö–ê IMAGE UPLOADER (–Ω–µ –∑–º—ñ–Ω—é—î—Ç—å—Å—è) ---
        
        const handlePaste = async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (isDead) {
                showStatusMessage('warning', '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ù–µ –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏ —Ñ–æ—Ç–æ!');
                return;
            }
            
            dom.pastePrompt.textContent = '–û–±—Ä–æ–±–ª—è—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...';
            dom.pasteArea.classList.add('bg-indigo-200', 'border-indigo-600');
            showStatusMessage('info', '–û–±—Ä–æ–±–ª—è—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è... ');

            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let imageFile = null;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    imageFile = items[i].getAsFile();
                    break;
                }
            }

            if (imageFile) {
                // 15. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–º—ñ—Ä—É (Firebase RTDB –º–∞—î –æ–±–º–µ–∂–µ–Ω–Ω—è ~10MB, –∞–ª–µ –∫—Ä–∞—â–µ –º–µ–Ω—à–µ)
                if (imageFile.size > 2 * 1024 * 1024) { // 2MB
                    showStatusMessage('error', '–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ ( > 2–ú–ë). –°–ø—Ä–æ–±—É–π—Ç–µ –º–µ–Ω—à–µ.');
                } else {
                    try {
                        const base64Data = await fileToBase64(imageFile);
                        await handleSaveBase64(base64Data); // –ó–º—ñ–Ω–µ–Ω–æ –Ω–∞ async
                    } catch (error) {
                        console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó Base64:", error);
                        showStatusMessage('error', '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.');
                    }
                }
            } else {
                showStatusMessage('warning', '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É –≤—Å—Ç–∞–≤–ª–µ–Ω–∏—Ö –¥–∞–Ω–∏—Ö.');
            }
            
            dom.pastePrompt.textContent = '–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —Ç—É—Ç —ñ –≤—Å—Ç–∞–≤—Ç–µ (Ctrl+V)';
            dom.pasteArea.classList.remove('bg-indigo-200', 'border-indigo-600');
        };
        
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // --- –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø UI –¢–ê –ü–û–î–Ü–ô ---

        function initUI() {
            // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö, –∞–ª–µ –¥–∏–Ω–∞–º—ñ—á–Ω–æ –≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö —Å–ø–∏—Å–∫—ñ–≤
            
            // Heal Tasks
            dom.healTasksList.innerHTML = '';
            HEALING_TASKS.forEach(task => {
                const button = document.createElement('button');
                button.className = "flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-pink-500 hover:bg-pink-600 disabled:opacity-50 disabled:cursor-not-allowed w-full";
                button.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> ${task.name}`;
                // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: handleHealthChange(healthChange, xpChange, ...)
                button.onclick = () => handleHealthChange(1, 0, `–õ—ñ–∫—É–≤–∞–Ω–Ω—è: ${task.name}`, 'heal');
                dom.healTasksList.appendChild(button);
            });

            // Penalty Tasks
            dom.penaltyTasksList.innerHTML = '';
            PENALTIES.forEach(penalty => {
                const button = document.createElement('button');
                button.className = "flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg bg-red-500 hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed w-full";
                button.innerHTML = `<i data-lucide="x-circle" class="w-5 h-5 mr-2"></i> ${penalty.name} (${penalty.health ? penalty.health + ' ‚ù§Ô∏è' : ''} ${penalty.xp ? (penalty.xp > 0 ? '+' : '') + penalty.xp + ' XP' : ''})`;
                // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: handleHealthChange(healthChange, xpChange, ...)
                button.onclick = () => handleHealthChange(penalty.health, penalty.xp, `–®—Ç—Ä–∞—Ñ: ${penalty.name}`, 'penalty');
                dom.penaltyTasksList.appendChild(button);
            });
            
            runLucide();

            // –ü—Ä–∏–≤'—è–∑–∫–∞ –ø–æ–¥—ñ–π
            dom.imageContainer.onclick = () => {
                if (!isDead) {
                    showImageInput = !showImageInput;
                    toggleElement(dom.imageUploader, showImageInput);
                    if(showImageInput) dom.pasteArea.focus();
                }
            };
            dom.closeImageUploader.onclick = () => {
                showImageInput = false;
                toggleElement(dom.imageUploader, false);
            };
            dom.pasteArea.onpaste = handlePaste;
            dom.removeImageBtn.onclick = handleRemoveImage;

            // XP (–ö–ª—é—á–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏)
            dom.addXpBtn.onclick = handleXPUpdate;
            dom.undoBtn.onclick = handleUndoLastAction;

            // Actions
            dom.cprBtn.onclick = handleCPR;
            dom.showHealBtn.onclick = () => {
                showHealOptions = !showHealOptions;
                showPenaltyOptions = false; // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ —ñ–Ω—à—É –ø–∞–Ω–µ–ª—å
                renderActionButtons();
            };
            dom.showPenaltyBtn.onclick = () => {
                showPenaltyOptions = !showPenaltyOptions;
                showHealOptions = false; // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ —ñ–Ω—à—É –ø–∞–Ω–µ–ª—å
                renderActionButtons();
            };
            dom.closeHealBtn.onclick = () => { showHealOptions = false; renderActionButtons(); };
            dom.closePenaltyBtn.onclick = () => { showPenaltyOptions = false; renderActionButtons(); };
            
            // Reset
            dom.showResetModalBtn.onclick = () => {
                showResetModal = true;
                toggleElement(dom.resetModal, true);
            };
            dom.cancelResetBtn.onclick = () => {
                showResetModal = false;
                toggleElement(dom.resetModal, false);
            };
            dom.confirmResetBtn.onclick = handleResetCharacter;
        }

        // --- –ì–û–õ–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø (–ó–ê–ü–£–°–ö) ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ DOM-–µ–ª–µ–º–µ–Ω—Ç–∏
            dom = {
                loader: document.getElementById('loader'),
                heartDisplay: document.getElementById('heart-display'),
                imageContainer: document.getElementById('image-container'),
                pupkaImage: document.getElementById('pupka-image'),
                imageUploader: document.getElementById('image-uploader'),
                closeImageUploader: document.getElementById('close-image-uploader'),
                pasteArea: document.getElementById('paste-area'),
                pastePrompt: document.getElementById('paste-prompt'),
                removeImageBtn: document.getElementById('remove-image-btn'),
                levelPrefix: document.getElementById('level-prefix'),
                levelName: document.getElementById('level-name'),
                levelDescription: document.getElementById('level-description'),
                xpCurrentText: document.getElementById('xp-current-text'),
                xpNeededText: document.getElementById('xp-needed-text'),
                xpProgressBar: document.getElementById('xp-progress-bar'),
                xpSectionContent: document.getElementById('xp-section-content'),
                multiplierCheckbox: document.getElementById('multiplier-checkbox'),
                multiplierLabel: document.getElementById('multiplier-label'),
                rewardsList: document.getElementById('rewards-list'),
                undoBtn: document.getElementById('undo-btn'),
                addXpBtn: document.getElementById('add-xp-btn'),
                cprSection: document.getElementById('cpr-section'),
                cprBtn: document.getElementById('cpr-btn'),
                actionButtonsContainer: document.getElementById('action-buttons-container'),
                showHealBtn: document.getElementById('show-heal-btn'),
                showPenaltyBtn: document.getElementById('show-penalty-btn'),
                healOptions: document.getElementById('heal-options'),
                healTasksList: document.getElementById('heal-tasks-list'),
                closeHealBtn: document.getElementById('close-heal-btn'),
                penaltyOptions: document.getElementById('penalty-options'),
                penaltyTasksList: document.getElementById('penalty-tasks-list'),
                closePenaltyBtn: document.getElementById('close-penalty-btn'),
                showResetModalBtn: document.getElementById('show-reset-modal-btn'),
                historySectionContent: document.getElementById('history-section-content'),
                historyList: document.getElementById('history-list'),
                userIdDisplay: document.getElementById('user-id-display'),
                resetModal: document.getElementById('reset-modal'),
                cancelResetBtn: document.getElementById('cancel-reset-btn'),
                confirmResetBtn: document.getElementById('confirm-reset-btn'),
                resetBtnText: document.getElementById('reset-btn-text'),
                statusAlert: document.getElementById('status-alert'),
                statusAlertIconContainer: document.getElementById('status-alert-icon-container'),
                statusAlertText: document.getElementById('status-alert-text'),
            };

            // 2. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ UI (–ø–æ–¥—ñ—ó, —Å—Ç–∞—Ç–∏—á–Ω—ñ —Å–ø–∏—Å–∫–∏)
            initUI();
            
            // 3. –ó–ê–ú–Ü–ù–ï–ù–û 'loadStateFromLocalStorage()' –ù–ê 'initFirebase()'
            initFirebase();
            
            // 4. –í–ò–î–ê–õ–ï–ù–û –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á–∞
            // if (dom.loader) dom.loader.style.display = 'none';
            
            // 5. –í–ò–î–ê–õ–ï–ù–û –ø–µ—Ä—à–∏–π —Ä–µ–Ω–¥–µ—Ä
            // renderAll();
        });
        
    </script>
</body>
</html>

