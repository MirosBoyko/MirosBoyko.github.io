<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –ë–µ–≥–∞</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–∞ Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .main-card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }
        .metric-value {
            line-height: 1;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex justify-center">

    <div id="app" class="w-full max-w-2xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800">üèÉ –ë–µ–≥–æ–≤–æ–π –¢—Ä–µ–∫–µ—Ä</h1>
            <p id="user-display" class="text-sm text-gray-500 mt-1"></p>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–±–µ–≥–∞ -->
        <div class="main-card bg-white p-6 rounded-3xl mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">–¢–µ–∫—É—â–∏–π –ó–∞–±–µ–≥</h2>

            <!-- –î–∏—Å–ø–ª–µ–π –¢–∞–π–º–µ—Ä–∞ -->
            <div class="text-center mb-6">
                <span id="timer-display" class="text-7xl sm:text-8xl font-black text-indigo-600 metric-value">00:00:00</span>
                <p class="text-sm font-medium text-gray-400 mt-1">–í–†–ï–ú–Ø</p>
            </div>

            <!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
            <div class="grid grid-cols-3 gap-4 text-center">
                <!-- –î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º) -->
                <div class="p-3 bg-indigo-50 rounded-xl">
                    <span id="distance-display" class="text-2xl font-bold text-gray-800 metric-value">0.00</span>
                    <p class="text-xs text-indigo-500 mt-1 uppercase font-medium">–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)</p>
                </div>
                <!-- –°—Ä–µ–¥–Ω–∏–π –¢–µ–º–ø (–º–∏–Ω/–∫–º) -->
                <div class="p-3 bg-indigo-50 rounded-xl">
                    <span id="pace-display" class="text-2xl font-bold text-gray-800 metric-value">--'--</span>
                    <p class="text-xs text-indigo-500 mt-1 uppercase font-medium">–¢–µ–º–ø (–º–∏–Ω/–∫–º)</p>
                </div>
                <!-- –ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª) -->
                <div class="p-3 bg-indigo-50 rounded-xl">
                    <span id="calories-display" class="text-2xl font-bold text-gray-800 metric-value">0</span>
                    <p class="text-xs text-indigo-500 mt-1 uppercase font-medium">–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)</p>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="mt-8 flex justify-center space-x-4">
                <button id="start-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg shadow-indigo-500/50 transition duration-150 transform hover:scale-105">
                    –°—Ç–∞—Ä—Ç
                </button>
                <button id="stop-button" disabled class="hidden bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg shadow-red-500/50 transition duration-150 transform hover:scale-105">
                    –°—Ç–æ–ø
                </button>
                <button id="reset-button" disabled class="hidden bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-8 rounded-full transition duration-150">
                    –°–±—Ä–æ—Å
                </button>
            </div>
            <div id="message-box" class="text-center mt-4 text-sm text-red-500 font-medium hidden"></div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –ò—Å—Ç–æ—Ä–∏–∏ –ó–∞–±–µ–≥–æ–≤ -->
        <div class="bg-white p-6 rounded-3xl main-card">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                –ò—Å—Ç–æ—Ä–∏—è –ó–∞–±–µ–≥–æ–≤
                <span id="loading-spinner" class="animate-spin h-5 w-5 border-2 border-indigo-500 border-r-transparent rounded-full hidden"></span>
            </h2>
            <div id="history-list" class="space-y-3">
                <p id="history-placeholder" class="text-gray-500 text-center py-4">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>
            </div>
        </div>
    </div>

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ Firestore

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Firebase, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ Canvas ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–µ–∫–µ—Ä–∞ ---
        let timerInterval;
        let startTime = 0;
        let isRunning = false;
        let totalSeconds = 0;

        // --- UI —ç–ª–µ–º–µ–Ω—Ç—ã ---
        const timerDisplay = document.getElementById('timer-display');
        const distanceDisplay = document.getElementById('distance-display');
        const paceDisplay = document.getElementById('pace-display');
        const caloriesDisplay = document.getElementById('calories-display');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const resetButton = document.getElementById('reset-button');
        const historyList = document.getElementById('history-list');
        const historyPlaceholder = document.getElementById('history-placeholder');
        const loadingSpinner = document.getElementById('loading-spinner');
        const messageBox = document.getElementById('message-box');
        const userDisplay = document.getElementById('user-display');

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–µ–∫—É–Ω–¥—ã –≤ HH:MM:SS
        function formatTime(seconds) {
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        // –í—ã–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = isError ? 'text-center mt-4 text-sm text-red-500 font-medium' : 'text-center mt-4 text-sm text-green-600 font-medium';
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        // –û–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        function updateMetrics() {
            if (totalSeconds === 0) {
                distanceDisplay.textContent = '0.00';
                paceDisplay.textContent = '--\'--';
                caloriesDisplay.textContent = '0';
                return;
            }

            // –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏: 1 –∫–º –∑–∞ –∫–∞–∂–¥—ã–µ 6 –º–∏–Ω—É—Ç (360 —Å–µ–∫—É–Ω–¥), —Å—Ä–µ–¥–Ω–∏–π —Ç–µ–º–ø 6:00 –º–∏–Ω/–∫–º
            const secondsPerKm = 360;
            const distanceKm = (totalSeconds / secondsPerKm);
            
            // –¢–µ–º–ø = totalSeconds / distanceKm (—Å–µ–∫—É–Ω–¥—ã/–∫–º)
            const paceTotalSeconds = totalSeconds / distanceKm;
            const paceMinutes = Math.floor(paceTotalSeconds / 60);
            const paceSeconds = Math.round(paceTotalSeconds % 60);
            const paceText = `${String(paceMinutes).padStart(2, '0')}'${String(paceSeconds).padStart(2, '0')}`;

            // –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π: ~70 –∫–∫–∞–ª –∑–∞ –∫–∞–∂–¥—ã–π –∫–∏–ª–æ–º–µ—Ç—Ä (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Å–∞ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏)
            const caloriesBurned = Math.round(distanceKm * 70);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            timerDisplay.textContent = formatTime(totalSeconds);
            distanceDisplay.textContent = distanceKm.toFixed(2);
            paceDisplay.textContent = paceText;
            caloriesDisplay.textContent = caloriesBurned;
        }

        // --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ç—Ä–µ–∫–µ—Ä–∞ ---

        function startRun() {
            if (isRunning) return;
            isRunning = true;
            startTime = Date.now() - (totalSeconds * 1000); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∫–Ω–æ–ø–æ–∫
            startButton.classList.add('hidden');
            stopButton.classList.remove('hidden');
            stopButton.disabled = false;
            resetButton.classList.add('hidden');
            resetButton.disabled = true;

            timerInterval = setInterval(() => {
                totalSeconds++;
                updateMetrics();
            }, 1000);

            showMessage("–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞—á–∞—Ç–∞!", false);
        }

        function stopRun() {
            if (!isRunning) return;
            clearInterval(timerInterval);
            isRunning = false;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∫–Ω–æ–ø–æ–∫
            startButton.classList.remove('hidden');
            startButton.disabled = true;
            stopButton.classList.add('hidden');
            resetButton.classList.remove('hidden');
            resetButton.disabled = false;
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Firestore
            saveRun();
            showMessage("–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ò–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...", false);
        }

        function resetRun() {
            if (isRunning) return;

            // –°–±—Ä–æ—Å –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π
            totalSeconds = 0;
            updateMetrics();

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∫–Ω–æ–ø–æ–∫
            startButton.classList.remove('hidden');
            startButton.disabled = false;
            stopButton.classList.add('hidden');
            resetButton.classList.add('hidden');
            resetButton.disabled = true;

            showMessage("–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã. –ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–±–µ–≥.", false);
        }

        // --- –õ–æ–≥–∏–∫–∞ Firestore ---

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–±–µ–≥–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        async function saveRun() {
            if (!db || !userId || totalSeconds < 60) {
                if (totalSeconds < 60 && totalSeconds > 0) {
                     showMessage("–ó–∞–±–µ–≥ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–º–∏–Ω–∏–º—É–º 60 —Å–µ–∫—É–Ω–¥).", true);
                }
                return;
            }

            const runData = {
                durationSeconds: totalSeconds,
                distanceKm: parseFloat(distanceDisplay.textContent),
                paceMinPerKm: paceDisplay.textContent,
                caloriesBurned: parseInt(caloriesDisplay.textContent),
                timestamp: serverTimestamp(),
                userId: userId,
            };

            const runsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/running_logs`);
            
            try {
                await addDoc(runsCollectionRef, runData);
                showMessage("–ó–∞–±–µ–≥ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!", false);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–±–µ–≥–∞:", error);
                showMessage("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.", true);
            } finally {
                // –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–±–µ–≥
                resetRun();
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ–¥–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏
        function renderRunItem(run) {
            const date = run.timestamp ? new Date(run.timestamp.seconds * 1000).toLocaleDateString('ru-RU') : 'N/A';
            const time = run.timestamp ? new Date(run.timestamp.seconds * 1000).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '';
            
            const div = document.createElement('div');
            div.className = 'p-4 bg-gray-50 rounded-xl border border-gray-100 flex justify-between items-center';
            div.innerHTML = `
                <div>
                    <p class="text-sm font-semibold text-gray-800">${date} ${time}</p>
                    <p class="text-xs text-gray-500">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${formatTime(run.durationSeconds)}</p>
                </div>
                <div class="text-right">
                    <p class="text-lg font-bold text-indigo-600">${run.distanceKm.toFixed(2)} –∫–º</p>
                    <p class="text-xs text-gray-600">–¢–µ–º–ø: ${run.paceMinPerKm}</p>
                    <p class="text-xs text-red-500">${run.caloriesBurned} –∫–∫–∞–ª</p>
                </div>
            `;
            return div;
        }

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ (onSnapshot)
        function subscribeToHistory() {
            if (!db || !userId) return;

            const runsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/running_logs`);
            
            // –ó–∞–ø—Ä–æ—Å: —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ —É–±—ã–≤–∞–Ω–∏—é
            const q = query(runsCollectionRef, orderBy("timestamp", "desc"));
            
            loadingSpinner.classList.remove('hidden');
            historyPlaceholder.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            onSnapshot(q, (snapshot) => {
                loadingSpinner.classList.add('hidden');
                historyList.innerHTML = '';

                if (snapshot.empty) {
                    historyPlaceholder.textContent = '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–±–µ–≥–æ–≤.';
                    historyList.appendChild(historyPlaceholder);
                    return;
                }

                snapshot.docs.forEach(doc => {
                    historyList.appendChild(renderRunItem(doc.data()));
                });
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—é:", error);
                loadingSpinner.classList.add('hidden');
                historyPlaceholder.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏.';
                historyList.appendChild(historyPlaceholder);
            });
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ---

        window.onload = async function() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                historyPlaceholder.textContent = '–û—à–∏–±–∫–∞: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.';
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        userDisplay.textContent = `User ID: ${userId}`;
                        subscribeToHistory(); // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è userId
                        console.log("Authenticated with UID:", userId);
                    } else {
                        // –ï—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥ –∏–ª–∏ UUID
                        userId = crypto.randomUUID(); 
                        isAuthReady = true;
                        userDisplay.textContent = `User ID: ${userId} (Anon)`;
                        historyPlaceholder.textContent = '–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏.';
                        console.warn("User not authenticated, using anonymous UUID.");
                    }
                });

                // –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ —Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º –∏–ª–∏ –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                historyPlaceholder.textContent = '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.';
            }

            // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Å–æ–±—ã—Ç–∏–π ---
            startButton.addEventListener('click', startRun);
            stopButton.addEventListener('click', stopRun);
            resetButton.addEventListener('click', resetRun);
        };
    </script>
</body>
</html>
