import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, runTransaction, serverTimestamp, collection, query, limit, orderBy, getDoc, getDocs, writeBatch } from 'firebase/firestore';
import { Heart, Zap, ChevronsUp, RefreshCw, XCircle, Clock, CheckCircle, RotateCcw, Image as ImageIcon, Trash2, RotateCcw as UndoIcon } from 'lucide-react';

// --- –ö–û–ù–°–¢–ê–ù–¢–ò –ì–†–ò ---

const LEVELS = [
  { name: '–ü—É–ø–∫–∞ (–ü–æ—á–∞—Ç–∫–æ–≤–∞ –ú–æ–ª–µ–∫—É–ª–∞)', minXp: 0, maxXp: 100, description: '–ú–∞–ª–µ–Ω—å–∫–∞, –∞–ª–µ –∂–≤–∞–≤–∞ —ñ—Å—Ç–æ—Ç–∞' },
  { name: '–ú—ñ–∫—Ä–æ–æ—Ä–≥–∞–Ω—ñ–∑–º', minXp: 101, maxXp: 250, description: '–ü–æ—á–∏–Ω–∞—î —Ä—É—Ö–∞—Ç–∏—Å—å —ñ —Å–≤—ñ—Ç–∏—Ç–∏—Å—å' },
  { name: '–ö–ª—ñ—Ç–∏–Ω–∫–∞ –ñ–∏—Ç—Ç—è', minXp: 251, maxXp: 500, description: '–ú–∞—î —Å–∏–ª—É –π —Ñ–æ—Ä–º—É' },
  { name: '–ú–∞–ª–µ–Ω—å–∫–µ –ó–≤—ñ—Ä—è—Ç–∫–æ', minXp: 501, maxXp: 900, description: '–ü–æ—á–∏–Ω–∞—î –ø—Ä–æ—è–≤–ª—è—Ç–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä' },
  { name: '–õ—é–¥–∏–Ω–∫–∞-–ü—É–ø–∫–∞', minXp: 901, maxXp: 1500, description: '–°–ø—Ä–∞–≤–∂–Ω—ñ–π –≥–µ—Ä–æ–π ‚Äî –¥–æ—Å—è–≥ –≥–∞—Ä–º–æ–Ω—ñ—ó' },
  { name: '–í–∏—â–∞ —Ñ–æ—Ä–º–∞ (–ù–æ–≤–∏–π –°–≤—ñ—Ç)', minXp: 1501, maxXp: 9999, description: '–î–æ—Å—è–≥–Ω—É—Ç–∞ –Ω–æ–≤–∞, –Ω–µ–≤—ñ–¥–æ–º–∞ —Ñ–æ—Ä–º–∞!' },
];

const MAX_HEALTH = 7; 

const REWARDS = [
  { id: 'base', name: 'üèÉ‚Äç‚ôÇÔ∏è –ë–∞–∑–æ–≤–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è (20+ —Ö–≤)', xp: 10 },
  { id: 'rain', name: 'üåßÔ∏è –ü–æ–≥–∞–Ω–∞ –ø–æ–≥–æ–¥–∞ / –î–æ—â', xp: 5, isBonus: true },
  { id: 'run5k', name: 'üèÉ‚Äç‚ôÄÔ∏è 5 –∫–º –±—ñ–≥—É', xp: 10 },
  { id: 'run10k', name: 'üèÉ 10 –∫–º –±—ñ–≥—É', xp: 25 },
  { id: 'run15k', name: 'ü¶ø 15 –∫–º –±—ñ–≥—É', xp: 50 },
  { id: 'squat150', name: 'üèãÔ∏è 150 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 10 },
  { id: 'squat300', name: 'üèãÔ∏è‚Äç‚ôÇÔ∏è 300 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 25 },
  { id: 'squat600', name: 'üèãÔ∏è‚Äç‚ôÄÔ∏è 600 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 50 },
  { id: 'squat1000', name: 'üí™ 1000 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å', xp: 100 },
  { id: 'pullup50', name: 'ü™ú 50 –ø—ñ–¥—Ç—è–≥—É–≤–∞–Ω—å (–¥–ª—è –Ω—å–æ–≥–æ)', xp: 5 },
  { id: 'pullup100', name: 'üßó 100 –ø—ñ–¥—Ç—è–≥—É–≤–∞–Ω—å (–¥–ª—è –Ω—å–æ–≥–æ)', xp: 10 },
  { id: 'menstrual', name: 'ü©∏ –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –º—ñ—Å—è—á–Ω–∏—Ö (–¥–ª—è –Ω–µ—ó)', xp: 5, isBonus: true },
  { id: 'walk3k', name: 'üö∂ –ü—Ä–æ–≥—É–ª—è–Ω–∫–∞ 3+ –∫–º', xp: 5 },
  { id: 'yoga', name: 'üßò –†–æ–∑—Ç—è–∂–∫–∞ / –ô–æ–≥–∞ (30 —Ö–≤)', xp: 10 },
  { id: 'early', name: 'üåÖ –†–∞–Ω–∫–æ–≤–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –¥–æ 8:00', xp: 5, isBonus: true },
  { id: 'fasted', name: 'üçΩÔ∏è –ë—ñ–≥ –Ω–∞—Ç—â–µ—Å–µ—Ä—Ü–µ', xp: 5, isBonus: true },
  { id: 'together', name: 'ü§ù –°–ø—ñ–ª—å–Ω–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è', xp: 10, isBonus: true },
  { id: 'reading', name: 'üìö –ß–∏—Ç–∞–Ω–Ω—è –∫–Ω–∏–≥–∏ (30 —Ö–≤)', xp: 5 },
];

const MULTIPLIER = { id: 'gymX2', name: '‚≠ê –î–æ–¥–∞—Ç–∫–æ–≤–µ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è —É —Å–ø–æ—Ä—Ç–∑–∞–ª—ñ (√ó2 XP)', factor: 2 };

const HEALING_TASKS = [
    { id: 'heal_squat500', name: 'üèãÔ∏è‚Äç‚ôÇÔ∏è 500 –ø—Ä–∏—Å—ñ–¥–∞–Ω—å' },
    { id: 'heal_water', name: 'üíß –ü–∏—Ç–∏ 2.5 –ª –≤–æ–¥–∏ (3 –¥–Ω—ñ –ø–æ—Å–ø—ñ–ª—å)' },
    { id: 'heal_meditate', name: 'üßò –†–æ–∑—Ç—è–∂–∫–∞ 30 —Ö–≤ (5 –¥–Ω—ñ–≤ –ø–æ—Å–ø—ñ–ª—å)' }, 
    { id: 'heal_diet', name: 'üö´ –¢–∏–∂–¥–µ–Ω—å –±–µ–∑ —Å–æ–ª–æ–¥–∫–æ–≥–æ/—Ñ–∞—Å—Ç—Ñ—É–¥—É (7 –¥–Ω—ñ–≤)' },
    { id: 'heal_nodopamine', name: 'üìµ 24 –≥–æ–¥–∏–Ω–∏ –±–µ–∑ –ª–µ–≥–∫–æ–≥–æ –¥–æ—Ñ–∞–º—ñ–Ω—É (–°–æ—Ü–º–µ—Ä–µ–∂—ñ/–Ü–≥—Ä–∏)' },
];

const PENALTIES = [
    { id: 'skip', name: '–ü—Ä–æ–ø—É—Å–∫ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è', health: -1, xp: 0 },
    { id: 'no_evolve', name: '–î–≤–∞ —Ç–∏–∂–Ω—ñ –±–µ–∑ –µ–≤–æ–ª—é—Ü—ñ—ó', health: -2, xp: 0 },
    { id: 'no_circle', name: '–ë–µ–∑ "–∫—Ä—É–∂–µ—á–∫—É" (–≤—ñ–¥–µ–æ–∑–≤—ñ—Ç—É)', health: 0, xp: -10 },
];

// --- –î–û–ü–û–ú–Ü–ñ–ù–Ü –ö–û–ú–ü–û–ù–ï–ù–¢–ò ---

const Button = ({ children, onClick, color = 'bg-indigo-600', icon: Icon, disabled, className = '' }) => (
  <button
    onClick={onClick}
    disabled={disabled}
    className={`flex items-center justify-center p-3 rounded-xl text-white font-semibold transition-all duration-200 shadow-lg ${color} hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed ${className}`}
  >
    {Icon && <Icon className='w-5 h-5 mr-2' />}
    {children}
  </button>
);

const HeartDisplay = ({ current, max }) => (
  <div className="flex flex-wrap justify-center gap-1">
    {[...Array(max)].map((_, i) => (
      <Heart
        key={i}
        className={`w-6 h-6 transition-colors duration-300 ${i < current ? 'fill-red-500 text-red-500' : 'fill-gray-300 text-gray-400'}`}
      />
    ))}
  </div>
);

// --- –û–°–ù–û–í–ù–ò–ô –ö–û–ú–ü–û–ù–ï–ù–¢ –î–û–î–ê–¢–ö–£ ---

const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [isDead, setIsDead] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [showResetModal, setShowResetModal] = useState(false);
  const [statusMessage, setStatusMessage] = useState(null); // –î–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è

  // –°—Ç–∞–Ω –≥—Ä–∏
  const [xp, setXp] = useState(0);
  const [health, setHealth] = useState(MAX_HEALTH);
  const [history, setHistory] = useState([]);
  const [characterBase64, setCharacterBase64] = useState(''); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Base64 –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
  const [lastActionId, setLastActionId] = useState(null); // ID –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –¥—ñ—ó
  const [showImageInput, setShowImageInput] = useState(false); 

  const [showHealOptions, setShowHealOptions] = useState(false);
  const [showPenaltyOptions, setShowPenaltyOptions] = useState(false);

  // –°—Ç–∞–Ω –¥–ª—è —Ñ–æ—Ä–º–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—è XP
  const [selectedActivities, setSelectedActivities] = useState([]);
  const [hasMultiplier, setHasMultiplier] = useState(false);
  
  // Ref –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
  const imageInputRef = useRef(null);

  // Firestore path constants
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è —É–Ω—ñ–∫–∞–ª—å–Ω–æ–≥–æ ID –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å—Ç–∞–Ω—É –≥—Ä–∏
  const GAME_DOC_ID = 'main_pupka_data';
  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ü—É–ø–∫–∏
  const DEFAULT_PUPKA_IMAGE_URL = 'image_915fcc.jpg';


  // 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase —Ç–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è
  useEffect(() => {
    if (firebaseConfig) {
      try {
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const authInstance = getAuth(app);
        
        setDb(firestore);
        setAuth(authInstance);

        const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
            if (user) {
                setUserId(user.uid);
            } else if (initialAuthToken) {
                await signInWithCustomToken(authInstance, initialAuthToken);
            } else {
                const anonymousUser = await signInAnonymously(authInstance);
                setUserId(anonymousUser.user.uid);
            }
            setIsAuthReady(true);
        });

        return () => unsubscribe();
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase:", error);
      }
    } else {
      console.warn("Firebase config –Ω–µ –Ω–∞–¥–∞–Ω–æ. –î–∞–Ω—ñ –Ω–µ –±—É–¥—É—Ç—å –∑–±–µ—Ä–µ–∂–µ–Ω—ñ.");
      setUserId('anon-local');
      setIsAuthReady(true);
    }
  }, [firebaseConfig, initialAuthToken]);

  // 2. –°–ª—É—Ö–∞—á Firestore –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –≥—Ä–∏
  useEffect(() => {
    if (db && userId) {
      const stateDocRef = doc(db, `artifacts/${appId}/users/${userId}/pupka_game/${GAME_DOC_ID}`);
      const historyColRef = collection(stateDocRef, 'history');
      
      // Listener –¥–ª—è —Å—Ç–∞–Ω—É
      const unsubscribeState = onSnapshot(stateDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          
          const newHealth = data.health !== undefined && data.health !== null ? data.health : MAX_HEALTH;

          setXp(data.xp || 0);
          setHealth(newHealth);
          setIsDead(newHealth <= 0); 
          setCharacterBase64(data.characterBase64 || '');
          setLastActionId(data.lastActionId || null); 
        } else {
          // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É, —è–∫—â–æ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ —ñ—Å–Ω—É—î
          setXp(0);
          setHealth(MAX_HEALTH);
          setIsDead(false);
          setCharacterBase64('');
          setLastActionId(null);
          if (userId !== 'anon-local') {
            setDoc(stateDocRef, { xp: 0, health: MAX_HEALTH, characterBase64: '', lastActionId: null, createdAt: serverTimestamp() }, { merge: true })
              .catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å—Ç–∞–Ω—É:", e));
          }
        }
      }, (error) => {
        console.error("–ü–æ–º–∏–ª–∫–∞ onSnapshot (state):", error);
      });

      // Listener –¥–ª—è —ñ—Å—Ç–æ—Ä—ñ—ó (–æ—Å—Ç–∞–Ω–Ω—ñ 10 –∑–∞–ø–∏—Å—ñ–≤)
      const q = query(historyColRef, orderBy('timestamp', 'desc'), limit(10));
      const unsubscribeHistory = onSnapshot(q, (snapshot) => {
        const newHistory = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
        }));
        setHistory(newHistory);
      }, (error) => {
        console.error("–ü–æ–º–∏–ª–∫–∞ onSnapshot (history):", error);
      });

      return () => {
        unsubscribeState();
        unsubscribeHistory();
      };
    }
  }, [db, userId, appId, GAME_DOC_ID]);

  // 3. Focus on Image Input when it appears
  useEffect(() => {
    if (showImageInput && imageInputRef.current) {
        imageInputRef.current.focus();
    }
  }, [showImageInput]);

  // --- –û–ë–ß–ò–°–õ–ï–ù–ù–Ø –°–¢–ê–ù–£ –ì–†–ò ---

  const currentLevel = useMemo(() => {
    return LEVELS.find(l => xp >= l.minXp && xp <= l.maxXp) || LEVELS[0];
  }, [xp]);

  const nextLevel = useMemo(() => {
    const currentIndex = LEVELS.findIndex(l => l.name === currentLevel.name);
    return LEVELS[currentIndex + 1] || currentLevel;
  }, [currentLevel]);

  const xpProgress = useMemo(() => {
    if (currentLevel.maxXp === nextLevel.maxXp) return 100;
    const range = nextLevel.minXp - currentLevel.minXp;
    const progress = xp - currentLevel.minXp;
    return Math.min(100, (progress / range) * 100);
  }, [xp, currentLevel, nextLevel]);

  const xpToNextLevel = useMemo(() => {
    const nextMin = nextLevel.minXp;
    if (xp >= nextMin) {
        return nextLevel.maxXp - xp;
    }
    return nextMin - xp;
  }, [xp, nextLevel]);


  // --- –§–£–ù–ö–¶–Ü–á –û–ù–û–í–õ–ï–ù–ù–Ø –°–¢–ê–ù–£ ---

  const getDocRef = () => doc(db, `artifacts/${appId}/users/${userId}/pupka_game/${GAME_DOC_ID}`);
  const getHistoryColRef = () => collection(getDocRef(), 'history');

  /**
   * –î–æ–¥–∞—î –∑–∞–ø–∏—Å –¥–æ —ñ—Å—Ç–æ—Ä—ñ—ó.
   * @param {string} type - –¢–∏–ø –¥—ñ—ó ('update', 'penalty', 'heal' —Ç–æ—â–æ).
   * @param {object} details - –î–µ—Ç–∞–ª—ñ –¥—ñ—ó.
   * @param {number} endHealth - –ö—ñ–Ω—Ü–µ–≤–µ –∑–¥–æ—Ä–æ–≤'—è –ø—ñ—Å–ª—è –¥—ñ—ó.
   */
  const addHistoryEntry = async (type, details, endHealth) => {
    if (!db || userId === 'anon-local') return;
    try {
        const historyRef = doc(getHistoryColRef());
        await setDoc(historyRef, {
            type,
            details: {
                ...details,
                endHealth: endHealth, 
            },
            timestamp: serverTimestamp(),
        }, {merge: true}); 
        
        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ ID –Ω–æ–≤–æ—Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        return historyRef.id;
    } catch (e) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó:", e);
        return null;
    }
  };

  /**
   * –û–Ω–æ–≤–ª—é—î —Å—Ç–∞–Ω –≥—Ä–∏ (XP —Ç–∞ –ó–¥–æ—Ä–æ–≤'—è).
   * @param {number} xpChange - –ó–º—ñ–Ω–∞ XP.
   * @param {number | 'SET_TO_ONE'} healthUpdate - –ó–º—ñ–Ω–∞ –∑–¥–æ—Ä–æ–≤'—è, –∞–±–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ 'SET_TO_ONE' –¥–ª—è –æ–∂–∏–≤–ª–µ–Ω–Ω—è.
   * @param {string} description - –û–ø–∏—Å –¥—ñ—ó –¥–ª—è —ñ—Å—Ç–æ—Ä—ñ—ó.
   * @param {string} type - –¢–∏–ø –¥—ñ—ó ('update', 'penalty', 'heal').
   */
  const updateGameState = async (xpChange, healthUpdate, description, type) => {
    if (!db || userId === 'anon-local' || isSaving) {
      console.warn("–ù–µ –º–æ–∂—É –∑–±–µ—Ä–µ–≥—Ç–∏: DB –Ω–µ –≥–æ—Ç–æ–≤–∞ –∞–±–æ –≤–∂–µ –∑–±–µ—Ä—ñ–≥–∞—é.");
      return;
    }
    
    setIsSaving(true);
    const docRef = getDocRef();

    try {
      let finalHealth = -1; // –î–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
      let historyId = null; // –î–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è ID —ñ—Å—Ç–æ—Ä—ñ—ó

      await runTransaction(db, async (transaction) => {
        const docSnap = await transaction.get(docRef);
        
        let currentXp = 0;
        let currentHealth = MAX_HEALTH;
        let currentBase64 = '';
        let currentLastActionId = null;

        if (docSnap.exists()) {
          const data = docSnap.data();
          currentHealth = data.health !== undefined && data.health !== null ? data.health : MAX_HEALTH;
          currentXp = data.xp || 0;
          currentBase64 = data.characterBase64 || '';
          currentLastActionId = data.lastActionId || null;
        }
        
        // --- –õ–û–ì–Ü–ö–ê –û–ù–û–í–õ–ï–ù–ù–Ø –ó–î–û–†–û–í'–Ø ---
        let calculatedHealth;
        
        if (healthUpdate === 'SET_TO_ONE' && currentHealth <= 0) {
            calculatedHealth = 1;
        } else if (typeof healthUpdate === 'number') {
            calculatedHealth = Math.min(MAX_HEALTH, Math.max(0, currentHealth + healthUpdate));
        } else {
             calculatedHealth = currentHealth;
        }

        // --- –õ–û–ì–Ü–ö–ê –û–ù–û–í–õ–ï–ù–ù–Ø XP ---
        const calculatedXp = Math.max(0, currentXp + xpChange);
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω isDead –ª–æ–∫–∞–ª—å–Ω–æ, —â–æ–± UI —Ä–µ–∞–≥—É–≤–∞–≤ —à–≤–∏–¥–∫–æ
        setIsDead(calculatedHealth <= 0); 
        finalHealth = calculatedHealth; // –ó–∞–ø–∏—Å—É—î–º–æ –∫—ñ–Ω—Ü–µ–≤–µ –∑–¥–æ—Ä–æ–≤'—è
        
        // –¢–∏–º—á–∞—Å–æ–≤–æ –æ–Ω–æ–≤–ª—é—î–º–æ –ª–∏—à–µ –æ—Å–Ω–æ–≤–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç
        transaction.set(docRef, { 
          xp: calculatedXp, 
          health: calculatedHealth,
          characterBase64: currentBase64, 
          updatedAt: serverTimestamp(),
          level: currentLevel.name,
          // lastActionId: –±—É–¥–µ –æ–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
        }, { merge: true });
        
        // –ü–æ–≤–µ—Ä–Ω–µ–º–æ –æ–±'—î–∫—Ç –∑ –¥–µ—Ç–∞–ª—è–º–∏ –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
        return { 
            xpChange: xpChange, 
            healthChange: healthUpdate, 
            description: description,
            finalHealth: calculatedHealth,
            type: type
        };
      });
      
      // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É —ñ—Å—Ç–æ—Ä—ñ—ó –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
      const newHistoryId = await addHistoryEntry(type, { 
          xpChange: xpChange, 
          healthChange: healthUpdate, 
          description: description 
      }, finalHealth);

      // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–æ–≤–∏–º lastActionId –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
      if (newHistoryId) {
          await setDoc(docRef, { lastActionId: newHistoryId }, { merge: true });
          setLastActionId(newHistoryId); // –û–Ω–æ–≤–ª—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
      }
      
      console.log("–°—Ç–∞–Ω –≥—Ä–∏ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ.");

    } catch (e) {
      console.error("–ü–æ–º–∏–ª–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É:", e);
      setStatusMessage({ type: 'error', text: '–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.' });
      setTimeout(() => setStatusMessage(null), 5000);
    } finally {
      setIsSaving(false);
    }
  };

  /**
   * –í—ñ–¥–º—ñ–Ω—è—î –æ—Å—Ç–∞–Ω–Ω—é –¥—ñ—é, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ lastActionId.
   */
  const handleUndoLastAction = async () => {
    if (!lastActionId || isSaving || !db || userId === 'anon-local') {
      setStatusMessage({ type: 'warning', text: '–ù–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏: –Ω–µ–º–∞—î –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –¥—ñ—ó –∞–±–æ —Å–∏—Å—Ç–µ–º–∞ –∑–∞–π–Ω—è—Ç–∞.' });
      return;
    }

    setIsSaving(true);
    const docRef = getDocRef();
    const historyDocRef = doc(getHistoryColRef(), lastActionId);

    try {
      let description = '';
      let isCprUndo = false;
      
      // –í–∏–Ω–æ—Å–∏–º–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –∑–∞ –º–µ–∂—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
      const historySnap = await getDoc(historyDocRef);
      if (!historySnap.exists()) {
        setStatusMessage({ type: 'error', text: '–ü–æ–º–∏–ª–∫–∞: –∑–∞–ø–∏—Å —ñ—Å—Ç–æ—Ä—ñ—ó –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.' });
        // –û—á–∏—â–∞—î–º–æ lastActionId, –æ—Å–∫—ñ–ª—å–∫–∏ –∑–∞–ø–∏—Å, –Ω–∞ —è–∫–∏–π –≤—ñ–Ω –≤–∫–∞–∑—É–≤–∞–≤, –∑–Ω–∏–∫
        await setDoc(docRef, { lastActionId: null }, { merge: true });
        setLastActionId(null); 
        setIsSaving(false);
        return;
      }
      
      const historyData = historySnap.data();
      const details = historyData.details || {};
      
      const undoneXpChange = details.xpChange ? -details.xpChange : 0;
      let undoneHealthChange = 0;
      
      if (typeof details.healthChange === 'number') {
        undoneHealthChange = -details.healthChange;
      } else if (details.healthChange === 'SET_TO_ONE') {
        isCprUndo = true; // –ü–æ–∑–Ω–∞—á–∞—î–º–æ, —â–æ —Ü–µ –≤—ñ–¥–º—ñ–Ω–∞ CPR
      }
      
      description = `–í–Ü–î–ú–Ü–ù–ê: ${details.description || '–Ω–µ–≤—ñ–¥–æ–º–æ—ó –¥—ñ—ó'}`;

      if (isCprUndo) {
        setStatusMessage({ type: 'error', text: '–í—ñ–¥–º—ñ–Ω–∞ ¬´–®—Ç—É—á–Ω–æ–≥–æ –¥–∏—Ö–∞–Ω–Ω—è¬ª (CPR) –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è. –°–∫–∏–Ω—å—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, —è–∫—â–æ —Ü–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ.' });
        setIsSaving(false);
        return;
      }
      
      // 2. –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è: –í—ñ–¥–∫–∞—Ç XP/Health, –æ—á–∏—â–µ–Ω–Ω—è lastActionId –¢–ê –≤–∏–¥–∞–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
      await runTransaction(db, async (transaction) => {
        const docSnap = await transaction.get(docRef);
        if (!docSnap.exists()) {
            throw new Error("–û—Å–Ω–æ–≤–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç Pupka –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.");
        }

        const data = docSnap.data();
        const currentXp = data.xp || 0;
        const currentHealth = data.health !== undefined && data.health !== null ? data.health : MAX_HEALTH;

        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É
        const calculatedXp = Math.max(0, currentXp + undoneXpChange);
        const calculatedHealth = Math.min(MAX_HEALTH, Math.max(0, currentHealth + undoneHealthChange));
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        transaction.update(docRef, { 
          xp: calculatedXp, 
          health: calculatedHealth,
          lastActionId: null, // –û—á–∏—â–∞—î–º–æ ID –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –¥—ñ—ó
          updatedAt: serverTimestamp(),
          level: (LEVELS.find(l => calculatedXp >= l.minXp && calculatedXp <= l.maxXp) || LEVELS[0]).name
        });

        // **–ö–†–ò–¢–ò–ß–ù–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø:** –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É —ñ—Å—Ç–æ—Ä—ñ—ó –≤ –º–µ–∂–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
        transaction.delete(historyDocRef);
      });
      
      setStatusMessage({ type: 'success', text: `–î—ñ—è —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–º—ñ–Ω–µ–Ω–∞: ${description}` });
      setLastActionId(null); // –û–Ω–æ–≤–ª—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
      
    } catch (e) {
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –ø–æ–º–∏–ª–∫–∞ –Ω–µ —Å—Ç–æ—Å—É—î—Ç—å—Å—è –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞, —è–∫—â–æ –º–∏ –≤–∂–µ –π–æ–≥–æ –≤–∏–¥–∞–ª–∏–ª–∏
      if (e.message.includes("–û—Å–Ω–æ–≤–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç Pupka –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")) {
         console.error("–ü–æ–º–∏–ª–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤—ñ–¥–º—ñ–Ω–∏ (–¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ):", e);
         setStatusMessage({ type: 'error', text: '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–º—ñ–Ω–∏ –¥—ñ—ó: –æ—Å–Ω–æ–≤–Ω–∏–π —Å—Ç–∞–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.' });
      } else {
        console.error("–ü–æ–º–∏–ª–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤—ñ–¥–º—ñ–Ω–∏:", e);
        setStatusMessage({ type: 'error', text: '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–º—ñ–Ω–∏ –¥—ñ—ó. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.' });
      }
    } finally {
      setIsSaving(false);
      setTimeout(() => setStatusMessage(null), 5000);
    }
  };


  // --- –§–£–ù–ö–¶–Ü–Ø: –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø BASE64 –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø ---
  const handleSaveBase64 = async (base64) => {
    // –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è, —è–∫—â–æ –ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞
    if (isDead) {
        setStatusMessage({ type: 'warning', text: '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ù–µ –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏ —Ñ–æ—Ç–æ, –ø–æ–∫–∏ —ó—ó –Ω–µ –æ–∂–∏–≤–ª—è—Ç—å!' });
        return;
    }
    
    if (!db || userId === 'anon-local' || isSaving) return;
    
    setIsSaving(true);
    setStatusMessage({ type: 'info', text: '–ó–±–µ—Ä—ñ–≥–∞—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è... –¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ —á–∞—Å.' });

    const docRef = getDocRef();
    try {
        await setDoc(docRef, { characterBase64: base64, updatedAt: serverTimestamp() }, { merge: true });
        setCharacterBase64(base64);
        setShowImageInput(false);
        setStatusMessage({ type: 'success', text: '–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ü—É–ø–∫–∏ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!' });
        console.log("Base64 –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ.");
    } catch (e) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è Base64 –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:", e);
        setStatusMessage({ type: 'error', text: '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è. –ú–æ–∂–ª–∏–≤–æ, –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ (–ª—ñ–º—ñ—Ç Firestore 1–ú–ë). –°–ø—Ä–æ–±—É–π—Ç–µ –º–µ–Ω—à–µ.' });
    } finally {
        setIsSaving(false);
        setTimeout(() => setStatusMessage(null), 5000);
    }
  };
  
  // --- –§–£–ù–ö–¶–Ü–Ø: –°–ö–ò–î–ê–ù–ù–Ø –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø ---
  const handleRemoveImage = () => {
    // –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è, —è–∫—â–æ –ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞
    if (isDead) {
        setStatusMessage({ type: 'warning', text: '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ù–µ –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏ —Ñ–æ—Ç–æ, –ø–æ–∫–∏ —ó—ó –Ω–µ –æ–∂–∏–≤–ª—è—Ç—å!' });
        return;
    }
    handleSaveBase64('');
    setShowImageInput(false);
  }

  // --- –§–£–ù–ö–¶–Ü–Ø: –ü–ï–†–ï–°–¢–í–û–†–ï–ù–ù–Ø –ü–ï–†–°–û–ù–ê–ñ–ê ---
  const handleResetCharacter = async () => {
    if (!db || userId === 'anon-local' || isSaving) {
      console.warn("–ù–µ –º–æ–∂—É —Å–∫–∏–Ω—É—Ç–∏: DB –Ω–µ –≥–æ—Ç–æ–≤–∞ –∞–±–æ –≤–∂–µ –∑–±–µ—Ä—ñ–≥–∞—é.");
      return;
    }

    setIsSaving(true);
    
    try {
        // 1. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (XP, –ó–¥–æ—Ä–æ–≤'—è, Base64)
        const docRef = getDocRef();
        await setDoc(docRef, { 
            xp: 0, 
            health: MAX_HEALTH,
            characterBase64: '', // –°–∫–∏–¥–∞—î–º–æ Base64
            lastActionId: null, // –û—á–∏—â–∞—î–º–æ
            updatedAt: serverTimestamp(),
            level: LEVELS[0].name,
        }, { merge: true });
        
        // 2. –í–∏–¥–∞–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó (Batch delete)
        const historyColRef = getHistoryColRef();
        const historySnapshot = await getDocs(historyColRef);
        
        const batch = writeBatch(db);
        historySnapshot.docs.forEach((d) => {
            batch.delete(d.ref);
        });
        
        await batch.commit();

        console.log("–ü–µ—Ä—Å–æ–Ω–∞–∂ —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–∏–π —Ç–∞ —ñ—Å—Ç–æ—Ä—ñ—è –æ—á–∏—â–µ–Ω–∞.");
        
        // –°–∫–∏–¥–∞–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É —Ñ–æ—Ä–º–∏ —Ç–∞ –º–æ–¥–∞–ª–æ–∫
        setSelectedActivities([]);
        setHasMultiplier(false);
        setShowHealOptions(false);
        setShowPenaltyOptions(false);
        setShowResetModal(false); 
        setCharacterBase64(''); // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
        setLastActionId(null);
        setIsDead(false); // –ó–Ω—è—Ç—Ç—è —Å—Ç–∞–Ω—É —Å–º–µ—Ä—Ç—ñ
        setStatusMessage({ type: 'success', text: '–ü–µ—Ä—Å–æ–Ω–∞–∂ —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–∏–π!' });

    } catch (e) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:", e);
        setStatusMessage({ type: 'error', text: '–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è.' });
    } finally {
        setIsSaving(false);
        setTimeout(() => setStatusMessage(null), 5000);
    }
  };

  // --- –õ–û–ì–Ü–ö–ê XP ---

  const handleXPUpdate = () => {
    // –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è, —è–∫—â–æ –ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞
    if (isDead) {
        setStatusMessage({ type: 'warning', text: '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ü–æ—Ç—Ä—ñ–±–Ω–µ ¬´–®—Ç—É—á–Ω–µ –¥–∏—Ö–∞–Ω–Ω—è¬ª (42 –∫–º –∑–∞ 2 –¥–Ω—ñ)!' });
        return;
    }
    
    if (selectedActivities.length === 0) return;

    let totalXP = selectedActivities.reduce((sum, activityId) => {
      const reward = REWARDS.find(r => r.id === activityId);
      return sum + (reward ? reward.xp : 0);
    }, 0);

    if (hasMultiplier) {
      totalXP *= MULTIPLIER.factor;
    }

    const description = `${selectedActivities.map(id => REWARDS.find(r => r.id === id)?.name || id).join(', ')}` + (hasMultiplier ? ` (√ó${MULTIPLIER.factor})` : '');

    updateGameState(totalXP, 0, `–û—Ç—Ä–∏–º–∞–Ω–æ XP: +${totalXP}. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ: ${description}`, 'update');

    setSelectedActivities([]);
    setHasMultiplier(false);
  };

  const toggleActivity = (id) => {
    // –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è, —è–∫—â–æ –ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞
    if (isDead) return;
    
    setSelectedActivities(prev =>
      prev.includes(id) ? prev.filter(item => item !== id) : [...prev, id]
    );
  };

  // --- –õ–û–ì–Ü–ö–ê –ó–î–û–†–û–í'–Ø ---

  const handleHealthChange = (healthChange, xpChange, actionName, type) => {
    // –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è, —è–∫—â–æ –ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞ —ñ —Ü–µ –Ω–µ –ª—ñ–∫—É–≤–∞–Ω–Ω—è
    if (isDead && healthChange <= 0) { 
         setStatusMessage({ type: 'warning', text: '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ë—ñ–ª—å—à–µ —à—Ç—Ä–∞—Ñ—ñ–≤ –Ω–∞–∫–ª–∞–¥–∞—Ç–∏ –Ω–µ –º–æ–∂–Ω–∞.' });
        return;
    }
    updateGameState(xpChange, healthChange, `${actionName}: ${healthChange > 0 ? '+' : ''}${healthChange} ‚ù§Ô∏è${xpChange !== 0 ? `, ${xpChange > 0 ? '+' : ''}${xpChange} XP` : ''}`, type);
    setShowHealOptions(false);
    setShowPenaltyOptions(false);
  };

  // –§—É–Ω–∫—Ü—ñ—è "–®—Ç—É—á–Ω–µ –¥–∏—Ö–∞–Ω–Ω—è"
  const handleCPR = async () => {
      if (!isDead) return; 
      updateGameState(0, 'SET_TO_ONE', '–û–ø—Ü—ñ—è ¬´–®—Ç—É—á–Ω–µ –¥–∏—Ö–∞–Ω–Ω—è¬ª (42 –∫–º –∑–∞ 2 –¥–Ω—ñ) –≤–∏–∫–æ–Ω–∞–Ω–∞. –ü—É–ø–∫–∞ –æ–∂–∏–ª–∞, –∞–ª–µ –≤–∏—Å–Ω–∞–∂–µ–Ω–∞.', 'heal');
  };

  // --- UI –ö–û–ú–ü–û–ù–ï–ù–¢–ò ---

  const ImageUploader = () => {
    const [isPasting, setIsPasting] = useState(false);
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—Å—Ç–∞–≤–ª–µ–Ω–æ–≥–æ —Ñ–∞–π–ª—É (–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è) –Ω–∞ Base64
    const fileToBase64 = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    };

    // –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ—ó "paste"
    const handlePaste = async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      // –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è, —è–∫—â–æ –ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞
      if (isDead) {
          setStatusMessage({ type: 'warning', text: '–ü—É–ø–∫–∞ –º–µ—Ä—Ç–≤–∞. –ù–µ –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏ —Ñ–æ—Ç–æ, –ø–æ–∫–∏ —ó—ó –Ω–µ –æ–∂–∏–≤–ª—è—Ç—å!' });
          return;
      }
      
      setIsPasting(true);
      setStatusMessage({ type: 'info', text: '–û–±—Ä–æ–±–ª—è—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è... '});

      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      let imageFile = null;

      // –ó–Ω–∞–π—Ç–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") !== -1) {
          imageFile = items[i].getAsFile();
          break;
        }
      }

      if (imageFile) {
        if (imageFile.size > 1024 * 1024) { // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —Ä–æ–∑–º—ñ—Ä 1–ú–ë
             setStatusMessage({ type: 'error', text: '–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ ( > 1–ú–ë). –°–ø—Ä–æ–±—É–π—Ç–µ –º–µ–Ω—à–µ.' });
             setIsPasting(false);
             return;
        }
        try {
          const base64Data = await fileToBase64(imageFile);
          handleSaveBase64(base64Data);
        } catch (error) {
          console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó Base64:", error);
          setStatusMessage({ type: 'error', text: '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.' });
        }
      } else {
        setStatusMessage({ type: 'warning', text: '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É –≤—Å—Ç–∞–≤–ª–µ–Ω–∏—Ö –¥–∞–Ω–∏—Ö.' });
      }
      setIsPasting(false);
      setTimeout(() => setStatusMessage(null), 5000);
    };

    return (
      <div className="p-4 mt-4 bg-indigo-50 rounded-xl border border-indigo-300 space-y-3">
        <div className="flex justify-between items-center">
            <h4 className="font-semibold text-indigo-800 flex items-center">
                <ImageIcon className="w-5 h-5 mr-2"/> –í—Å—Ç–∞–≤–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (Ctrl+V)
            </h4>
            <button 
                onClick={() => setShowImageInput(false)} 
                className="text-gray-500 hover:text-gray-700"
                disabled={isDead} 
            >
                <XCircle className="w-5 h-5"/>
            </button>
        </div>
        
        {/* –ü–æ–ª–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ */}
        <div
            ref={imageInputRef}
            onPaste={handlePaste}
            tabIndex="0" 
            className={`w-full p-4 h-24 border-2 border-dashed rounded-lg text-center cursor-text 
                        transition-all duration-200 
                        ${isPasting ? 'bg-indigo-200 border-indigo-600' : 'bg-white border-gray-300 hover:border-indigo-500'}
                        focus:outline-none focus:ring-2 focus:ring-indigo-500
                        ${isDead ? 'opacity-50 cursor-not-allowed' : ''}
                        `}
            style={{ pointerEvents: isDead ? 'none' : 'auto' }} 
        >
            <p className="text-gray-500 font-medium mt-2">
                {isPasting ? '–û—á—ñ–∫—É—é –≤—Å—Ç–∞–≤–∫–∏...' : '–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —Ç—É—Ç —ñ –≤—Å—Ç–∞–≤—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (Ctrl+V)'}
            </p>
        </div>

        {/* –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è */}
        <Button
            onClick={handleRemoveImage}
            icon={Trash2}
            color="bg-red-500 hover:bg-red-600"
            disabled={isSaving || !characterBase64 || isDead}
            className="w-full"
        >
            –°–∫–∏–Ω—É—Ç–∏ —Ñ–æ—Ç–æ –ü—É–ø–∫–∏
        </Button>
      </div>
    );
  };

  const XpInputSection = () => (
    <div className={`bg-white p-6 rounded-2xl shadow-xl space-y-4 ${isDead ? 'opacity-50 pointer-events-none' : ''}`}>
      <h3 className="text-xl font-bold text-gray-800 flex items-center"><Zap className="w-6 h-6 mr-2 text-indigo-600"/> –î–æ–¥–∞—Ç–∏ XP –∑–∞ –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</h3>
      
      {/* –ú–Ω–æ–∂–Ω–∏–∫ X2 */}
      <label className="flex items-center space-x-3 p-3 bg-yellow-50 rounded-lg border border-yellow-300 cursor-pointer transition-all hover:bg-yellow-100">
        <input 
          type="checkbox" 
          checked={hasMultiplier} 
          onChange={() => setHasMultiplier(!hasMultiplier)} 
          className="form-checkbox h-5 w-5 text-indigo-600 rounded"
          disabled={isDead} 
        />
        <span className="font-semibold text-yellow-800">{MULTIPLIER.name}</span>
      </label>

      {/* –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π */}
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-96 overflow-y-auto pr-2">
        {REWARDS.map(reward => {
            let rewardName = reward.name;
            let rewardXp = reward.xp;
            
            if (reward.id === 'yoga') {
              rewardName = 'üßò –†–æ–∑—Ç—è–∂–∫–∞ / –ô–æ–≥–∞ (30 —Ö–≤)'; 
            }
            
            return (
              <div 
                key={reward.id}
                onClick={() => toggleActivity(reward.id)}
                className={`p-3 rounded-lg border cursor-pointer transition-all ${
                  selectedActivities.includes(reward.id) 
                    ? 'bg-indigo-100 border-indigo-500 shadow-md' 
                    : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                } ${isDead ? 'opacity-70 cursor-not-allowed' : ''}`}
              >
                <div className="font-medium text-gray-700">{rewardName}</div>
                <div className={`text-sm font-bold ${reward.isBonus ? 'text-green-600' : 'text-indigo-600'}`}>+{rewardXp} XP</div>
              </div>
            );
          })}
      </div>
      
      {/* –ö–Ω–æ–ø–∫–∏ –î—ñ—ó XP */}
      <div className="flex space-x-3 pt-2">
        {/* –ö–ù–û–ü–ö–ê –í–Ü–î–ú–Ü–ù–ò / –ö–†–û–ö –ù–ê–ó–ê–î */}
        <Button 
          onClick={handleUndoLastAction} 
          icon={UndoIcon}
          disabled={!lastActionId || isSaving || isDead} 
          color="bg-orange-500 hover:bg-orange-600"
        >
          –ö—Ä–æ–∫ –Ω–∞–∑–∞–¥
        </Button>
        
        {/* –ö–ù–û–ü–ö–ê –ó–ê–†–ê–•–£–í–ê–¢–ò XP */}
        <Button 
          onClick={handleXPUpdate} 
          icon={ChevronsUp}
          disabled={selectedActivities.length === 0 || isSaving || isDead} 
          color="bg-green-600 hover:bg-green-700 flex-grow"
        >
          –ó–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ XP
        </Button>
      </div>

    </div>
  );

  const StatusDisplay = () => {
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Base64, —è–∫—â–æ –≤—ñ–Ω –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π, —ñ–Ω–∞–∫—à–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π URL
    const currentImageSrc = characterBase64 || DEFAULT_PUPKA_IMAGE_URL;

    return (
        <div className="bg-white p-6 rounded-2xl shadow-xl text-center space-y-4">
          <h1 className="text-3xl font-extrabold text-indigo-700">–ü—É–ø–∫–∞</h1>
          
          {/* Health Display */}
          <div className="flex justify-center mb-4">
            <HeartDisplay current={health} max={MAX_HEALTH} />
          </div>

          {/* Character Visualization (Pupka Image) */}
          <div 
            onClick={() => { if (!isDead) setShowImageInput(!showImageInput); }} 
            className={`w-28 h-28 mx-auto mb-4 rounded-full overflow-hidden shadow-xl border-4 border-indigo-200 transition-all duration-300 transform ${!isDead ? 'hover:scale-105 cursor-pointer' : 'opacity-70 cursor-not-allowed'}`}
            role="button"
            aria-label="–ó–º—ñ–Ω–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ü—É–ø–∫–∏"
          >
            <img 
              src={currentImageSrc} 
              alt="Pupka Character" 
              className="w-full h-full object-cover"
              // –ê–≤–∞—Ä—ñ–π–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç, —è–∫—â–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (URL –∞–±–æ Base64) –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è
              onError={(e) => {
                e.target.onerror = null; 
                e.target.src = 'https://placehold.co/112x112/ff9900/ffffff?text=Pupka';
                e.target.className = "w-full h-full object-contain p-2";
              }}
            />
          </div>
          
          {/* –ü–æ–ª–µ –≤–≤–æ–¥—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è */}
          {showImageInput && <ImageUploader />}


          {/* Evolution Level */}
          <div className="font-semibold text-lg text-gray-600 pt-4 border-t border-gray-100">
            –†—ñ–≤–µ–Ω—å {LEVELS.findIndex(l => l.name === currentLevel.name) + 1}
          </div>
          <h2 className="text-2xl font-bold text-indigo-600 mb-2">{currentLevel.name}</h2>
          <p className="text-sm italic text-gray-500">{currentLevel.description}</p>

          {/* XP Bar */}
          <div className="pt-2">
            <div className="text-sm font-medium text-gray-700 flex justify-between">
              <span>XP: {xp}</span>
              <span>{xpToNextLevel > 0 ? `–î–æ –ù–∞—Å—Ç. –†—ñ–≤–Ω—è: ${xpToNextLevel}` : 'MAX'}</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-4 mt-1">
              <div 
                className={`h-4 rounded-full transition-all duration-700 ${xpProgress >= 100 ? 'bg-green-500' : 'bg-yellow-500'}`}
                style={{ width: `${xpProgress}%` }}
              ></div>
            </div>
          </div>
        </div>
    );
  };

  const ActionButtons = () => (
    <div className="bg-white p-6 rounded-2xl shadow-xl space-y-4">
      <h3 className="text-xl font-bold text-gray-800">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ó–¥–æ—Ä–æ–≤'—è–º (‚ù§Ô∏è)</h3>

      {/* –ó–¥–æ—Ä–æ–≤'—è = 0 */}
      {isDead && (
        <div className="p-4 bg-red-100 border border-red-400 rounded-xl text-red-800 font-semibold text-center space-y-3">
          <p className="font-bold text-lg">üíÄ –°–º–µ—Ä—Ç—å –ü—É–ø–∫–∏!</p>
          <p>–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ ¬´–®—Ç—É—á–Ω–µ –¥–∏—Ö–∞–Ω–Ω—è¬ª!</p>
          <Button 
            onClick={handleCPR} 
            icon={RefreshCw}
            disabled={isSaving}
            color="bg-red-600 hover:bg-red-700"
          >
            42 –∫–º –∑–∞ 2 –¥–Ω—ñ (–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ 1 ‚ù§Ô∏è)
          </Button>
          <p className="text-sm text-red-600">–Ø–∫—â–æ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–æ, –ü—É–ø–∫–∞ –ø–æ–º–µ—Ä–ª–∞ –Ω–∞–∑–∞–≤–∂–¥–∏.</p>
        </div>
      )}

      {/* –ö–Ω–æ–ø–∫–∏ –î—ñ—ó */}
      <div className={`grid grid-cols-2 gap-3 ${isDead ? 'opacity-50 pointer-events-none' : ''}`}>
        <Button 
          onClick={() => setShowHealOptions(!showHealOptions)} 
          icon={Heart}
          disabled={isSaving || isDead || health === MAX_HEALTH} 
          color="bg-pink-600 hover:bg-pink-700"
        >
          –õ—ñ–∫—É–≤–∞–Ω–Ω—è (+1 ‚ù§Ô∏è)
        </Button>
        <Button 
          onClick={() => setShowPenaltyOptions(!showPenaltyOptions)} 
          icon={XCircle}
          disabled={isSaving || isDead} 
          color="bg-gray-600 hover:bg-gray-700"
        >
          –®—Ç—Ä–∞—Ñ (‚Äî ‚ù§Ô∏è/XP)
        </Button>
      </div>

      {/* –ü–∞–Ω–µ–ª—å –õ—ñ–∫—É–≤–∞–Ω–Ω—è */}
      {showHealOptions && !isDead && ( 
        <div className="p-4 bg-pink-50 rounded-xl border border-pink-300 space-y-2">
          <h4 className="font-semibold text-pink-800">–í–∏–∫–æ–Ω–∞–Ω—ñ –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –õ—ñ–∫—É–≤–∞–Ω–Ω—è (+1 ‚ù§Ô∏è):</h4>
          {HEALING_TASKS.map(task => (
            <Button 
              key={task.id} 
              onClick={() => handleHealthChange(1, 0, `–õ—ñ–∫—É–≤–∞–Ω–Ω—è: ${task.name}`, 'heal')}
              icon={CheckCircle}
              disabled={isSaving || health === MAX_HEALTH}
              color="bg-pink-500 hover:bg-pink-600 w-full"
            >
              {task.name}
            </Button>
          ))}
          {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –æ–ø—Ü—ñ–π */}
           <Button 
              onClick={() => setShowHealOptions(false)}
              color="bg-gray-400 hover:bg-gray-500"
              className="w-full mt-2"
           >
              –ó–∞–∫—Ä–∏—Ç–∏
           </Button>
        </div>
      )}

      {/* –ü–∞–Ω–µ–ª—å –®—Ç—Ä–∞—Ñ—ñ–≤ */}
      {showPenaltyOptions && !isDead && ( 
        <div className="p-4 bg-gray-50 rounded-xl border border-gray-300 space-y-2">
          <h4 className="font-semibold text-gray-800">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –®—Ç—Ä–∞—Ñ:</h4>
          {PENALTIES.map(penalty => (
            <Button 
              key={penalty.id} 
              onClick={() => handleHealthChange(penalty.health, penalty.xp, `–®—Ç—Ä–∞—Ñ: ${penalty.name}`, 'penalty')}
              icon={XCircle}
              disabled={isSaving}
              color="bg-red-500 hover:bg-red-600 w-full"
            >
              {penalty.name} ({penalty.health ? penalty.health + ' ‚ù§Ô∏è' : ''} {penalty.xp ? (penalty.xp > 0 ? '+' : '') + penalty.xp + ' XP' : ''})
            </Button>
          ))}
          {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –æ–ø—Ü—ñ–π */}
           <Button 
              onClick={() => setShowPenaltyOptions(false)}
              color="bg-gray-400 hover:bg-gray-500"
              className="w-full mt-2"
           >
              –ó–∞–∫—Ä–∏—Ç–∏
           </Button>
        </div>
      )}

      {/* –ö–Ω–æ–ø–∫–∞ –°–∫–∏–¥–∞–Ω–Ω—è/–ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è (–ó–∞–≤–∂–¥–∏ –¥–æ—Å—Ç—É–ø–Ω–∞) */}
      <div className="pt-4 border-t border-gray-200">
        <Button 
          onClick={() => setShowResetModal(true)} 
          icon={RotateCcw}
          disabled={isSaving}
          color="bg-red-500 hover:bg-red-600"
        >
          –ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–°–∫–∏–Ω—É—Ç–∏ –≤—Å–µ)
        </Button>
      </div>

    </div>
  );

  const HistorySection = () => (
    <div className={`bg-white p-6 rounded-2xl shadow-xl space-y-4 col-span-1 lg:col-span-2 ${isDead ? 'opacity-50 pointer-events-none' : ''}`}>
      <h3 className="text-xl font-bold text-gray-800">–Ü—Å—Ç–æ—Ä—ñ—è –ü—Ä–æ–≥—Ä–µ—Å—É (–û—Å—Ç–∞–Ω–Ω—ñ 10)</h3>
      <div className="max-h-80 overflow-y-auto space-y-2 pr-2">
        {history.length === 0 ? (
          <p className="text-gray-500 italic">–¢—É—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏–º—É—Ç—å—Å—è –≤–∞—à—ñ –¥—ñ—ó.</p>
        ) : (
          history.map((item) => {
            const healthStatus = item.details?.endHealth !== undefined && item.details.endHealth !== null
                ? ` (${item.details.endHealth}/${MAX_HEALTH} ‚ù§Ô∏è)`
                : ''; 
            
            // –í–∏–¥—ñ–ª–µ–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –¥—ñ—ó
            const isLastAction = lastActionId === item.id;
            
            return (
              <div 
                key={item.id} 
                className={`p-3 rounded-lg border-l-4 shadow-sm flex justify-between items-center transition-all duration-300 ${
                    isLastAction 
                        ? 'border-orange-500 bg-orange-100' 
                        : 'border-indigo-500 bg-gray-50'
                }`}
              >
                <span className="text-gray-700 font-medium break-words w-4/5">
                    {isLastAction && <span className="font-extrabold text-orange-700 mr-1">[–û–°–¢–ê–ù–ù–Ø]</span>}
                    {item.details?.description || item.type}
                    <span className="font-bold text-indigo-600">{healthStatus}</span>
                </span>
                <span className="text-xs text-gray-500 whitespace-nowrap flex items-center">
                  <Clock className="w-3 h-3 mr-1" />
                  {item.timestamp && item.timestamp.seconds ? new Date(item.timestamp.seconds * 1000).toLocaleTimeString('uk-UA', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : '...'}
                </span>
              </div>
            );
          })
        )}
      </div>
      <p className="text-xs text-center text-gray-400">ID –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {userId || '...'} (–î–ª—è —Å–ø—ñ–ª—å–Ω–æ–≥–æ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è)</p>
    </div>
  );
  
  // --- –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –ü–Ü–î–¢–í–ï–†–î–ñ–ï–ù–ù–Ø –°–ö–ò–ù–£–¢–¢–Ø ---
  const ResetConfirmationModal = () => {
    if (!showResetModal) return null;

    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
        <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full space-y-4">
          <h3 className="text-xl font-bold text-red-600">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</h3>
          <p className="text-gray-700">–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ü—É–ø–∫—É?</p>
          <p className="text-sm text-gray-500">–¶—è –¥—ñ—è —Å–∫–∏–Ω–µ **XP, –ó–¥–æ—Ä–æ–≤'—è** —Ç–∞ **–ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–ª–∏—Ç—å —ñ—Å—Ç–æ—Ä—ñ—é**. –¶–µ –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.</p>
          <div className="flex justify-end space-x-3">
            <Button 
              onClick={() => setShowResetModal(false)} 
              color="bg-gray-500 hover:bg-gray-600"
              disabled={isSaving}
            >
              –°–∫–∞—Å—É–≤–∞—Ç–∏
            </Button>
            <Button 
              onClick={handleResetCharacter} 
              icon={RotateCcw}
              color="bg-red-600 hover:bg-red-700"
              disabled={isSaving}
            >
              {isSaving ? '–°–∫–∏–¥–∞—é...' : '–ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏'}
            </Button>
          </div>
        </div>
      </div>
    );
  };

  // --- UI –î–õ–Ø –°–¢–ê–¢–£–°–ù–ò–• –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨ ---
  const StatusAlert = () => {
    if (!statusMessage) return null;
    
    let colorClass, Icon;
    switch (statusMessage.type) {
        case 'success':
            colorClass = 'bg-green-100 text-green-800 border-green-400';
            Icon = CheckCircle;
            break;
        case 'error':
            colorClass = 'bg-red-100 text-red-800 border-red-400';
            Icon = XCircle;
            break;
        case 'warning':
            colorClass = 'bg-yellow-100 text-yellow-800 border-yellow-400';
            Icon = Zap;
            break;
        case 'info':
        default:
            colorClass = 'bg-blue-100 text-blue-800 border-blue-400';
            Icon = RefreshCw;
            break;
    }

    return (
        <div className={`fixed bottom-4 right-4 z-50 p-4 rounded-xl shadow-lg border-l-4 font-semibold max-w-xs ${colorClass} flex items-center`}>
            <Icon className={`w-5 h-5 mr-3 ${statusMessage.type === 'info' ? 'animate-spin' : ''}`} />
            {statusMessage.text}
        </div>
    );
  };

  // --- –ì–û–õ–û–í–ù–ò–ô –†–ï–ù–î–ï–† ---

  if (!isAuthReady) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <div className="text-indigo-600 text-lg font-semibold flex items-center">
          <RefreshCw className="w-6 h-6 mr-3 animate-spin" /> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ü—É–ø–∫–∏...
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 p-4 sm:p-8 font-sans">
      <script src="https://cdn.tailwindcss.com"></script>
      <div className="max-w-4xl mx-auto space-y-8">
        
        {/* –•–µ–¥–µ—Ä —ñ –°—Ç–∞—Ç—É—Å */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="md:col-span-1">
            <StatusDisplay />
          </div>
          {/* XP (–ù–∞ –ø–µ—Ä—à–æ–º—É –º—ñ—Å—Ü—ñ —É –ø—Ä–∞–≤—ñ–π –∫–æ–ª–æ–Ω—Ü—ñ) */}
          <div className="md:col-span-2">
            <XpInputSection />
          </div>
        </div>

        {/* –°–µ–∫—Ü—ñ—è –î—ñ–π —Ç–∞ –Ü—Å—Ç–æ—Ä—ñ—è */}
        <div className="grid grid-cols-1 lg:col-span-2 gap-6">
            <ActionButtons />
            <HistorySection />
        </div>
        
      </div>
      
      <ResetConfirmationModal /> 
      <StatusAlert />
    </div>
  );
};

export default App;
